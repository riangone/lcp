@using Platform.Infrastructure.Definitions
@model IEnumerable<Dictionary<string, object>>
@{
    var def = (ModelDefinition)ViewData["ModelDef"]!;
    var modelName = (string)ViewData["ModelName"]!;
    var pageNum = (int)ViewData["Page"]!;
    var size = (int)ViewData["Size"]!;
    var total = (int)ViewData["Total"]!;
    var totalPages = (int)Math.Ceiling((double)total / size);
    var currentLang = Context.Request.Query["lang"].FirstOrDefault() ?? "en";
    var currentProject = Context.Request.Query["project"].FirstOrDefault() ?? "todo";
    var currentSortBy = (ViewData["SortBy"] as string) ?? def.PrimaryKey;
    var currentSortDir = string.Equals(ViewData["SortDir"] as string, "desc", StringComparison.OrdinalIgnoreCase) ? "desc" : "asc";

    var localizedLabels = currentLang == "zh" ? def.Ui?.Labels?.Zh : def.Ui?.Labels?.En;
    var title = localizedLabels != null && localizedLabels.ContainsKey("title") ? localizedLabels["title"] : modelName;

    // Áä∂ÊÄÅÈ¢úËâ≤ÂíåÂõæÊ†á
    var statusConfig = new Dictionary<string, (string color, string icon, string label)>
    {
        { "pending", ("bg-amber-100 text-amber-700", "‚è≥", currentLang == "zh" ? "ÂæÖÂ§ÑÁêÜ" : "Pending") },
        { "in_progress", ("bg-blue-100 text-blue-700", "üîÑ", currentLang == "zh" ? "ËøõË°å‰∏≠" : "In Progress") },
        { "completed", ("bg-emerald-100 text-emerald-700", "‚úÖ", currentLang == "zh" ? "Â∑≤ÂÆåÊàê" : "Completed") },
        { "blocked", ("bg-red-100 text-red-700", "üö´", currentLang == "zh" ? "Â∑≤ÈòªÂ°û" : "Blocked") }
    };
}

<div class="todo-app-container">
    <!-- Â§¥ÈÉ®ÁªüËÆ° -->
    <div class="todo-header">
        <div class="header-content">
            <h1 class="app-title">
                <span class="title-icon">üìã</span>
                @title
            </h1>
            <div class="stats-bar">
                <div class="stat-badge stat-total">
                    <span class="stat-number">@total</span>
                    <span class="stat-label">@(currentLang == "zh" ? "ÊÄª‰ªªÂä°" : "Total")</span>
                </div>
                <div class="stat-badge stat-pending">
                    <span class="stat-number">@Model.Count(m => m.ContainsKey("Status") && m["Status"]?.ToString() == "pending")</span>
                    <span class="stat-label">@(currentLang == "zh" ? "ÂæÖÂ§ÑÁêÜ" : "Pending")</span>
                </div>
                <div class="stat-badge stat-progress">
                    <span class="stat-number">@Model.Count(m => m.ContainsKey("Status") && m["Status"]?.ToString() == "in_progress")</span>
                    <span class="stat-label">@(currentLang == "zh" ? "ËøõË°å‰∏≠" : "Progress")</span>
                </div>
                <div class="stat-badge stat-completed">
                    <span class="stat-number">@Model.Count(m => m.ContainsKey("Status") && m["Status"]?.ToString() == "completed")</span>
                    <span class="stat-label">@(currentLang == "zh" ? "Â∑≤ÂÆåÊàê" : "Done")</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Â∑•ÂÖ∑Ê†è -->
    <div class="todo-toolbar">
        <div class="toolbar-actions">
            <a href="/ui/Task/create?project=@currentProject&lang=@currentLang" class="btn-new-task">
                <span class="btn-icon">‚ûï</span>
                <span>@(currentLang == "zh" ? "Êñ∞Âª∫‰ªªÂä°" : "New Task")</span>
            </a>
        </div>
        <div class="toolbar-search">
            <form class="search-form" hx-get="/ui/Task?project=@currentProject" hx-target="#task-list" hx-swap="innerHTML">
                <input type="text" name="Title" placeholder="@(currentLang == "zh" ? "ÊêúÁ¥¢‰ªªÂä°..." : "Search tasks...")" 
                       value="@(Context.Request.Query["Title"].FirstOrDefault() ?? "")" class="search-input" />
                <button type="submit" class="btn-search"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>

    <!-- ‰ªªÂä°ÂàóË°® -->
    <div id="task-list" class="task-board">
        @foreach (var task in Model)
        {
            var id = task[def.PrimaryKey]?.ToString() ?? "";
            var titleText = task.ContainsKey("Title") ? task["Title"]?.ToString() ?? "" : "";
            var status = task.ContainsKey("Status") ? task["Status"]?.ToString() ?? "pending" : "pending";
            var priority = task.ContainsKey("Priority") ? task["Priority"]?.ToString() ?? "medium" : "medium";
            var dueDate = task.ContainsKey("DueDate") ? task["DueDate"]?.ToString() ?? "" : "";
            var assignee = task.ContainsKey("Assignee") ? task["Assignee"]?.ToString() ?? "" : "";

            var statusInfo = statusConfig.ContainsKey(status) ? statusConfig[status] : statusConfig["pending"];
            
            // ‰ºòÂÖàÁ∫ßÊ†∑Âºè
            var priorityClass = priority switch
            {
                "high" => "priority-high",
                "low" => "priority-low",
                _ => "priority-medium"
            };
        }
        <div class="task-card @priorityClass" data-id="@id" data-status="@status">
            <div class="task-card-header">
                <div class="task-id">#@id</div>
                <div class="task-actions">
                    <a href="/ui/Task/edit/@id?project=@currentProject&lang=@currentLang" class="btn-edit" title="@(currentLang == "zh" ? "ÁºñËæë" : "Edit")">
                        ‚úèÔ∏è
                    </a>
                    <button class="btn-delete" onclick="openDeleteDialog('@modelName', '@id')" title="@(currentLang == "zh" ? "Âà†Èô§" : "Delete")">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            <h3 class="task-title">@titleText</h3>
            <div class="task-meta">
                <span class="task-status @status">
                    <span class="status-icon">@statusInfo.icon</span>
                    <span class="status-label">@statusInfo.label</span>
                </span>
                <span class="task-priority @priority">
                    @(currentLang == "zh" ? priority switch { "high" => "È´ò‰ºòÂÖàÁ∫ß", "low" => "‰Ωé‰ºòÂÖàÁ∫ß", _ => "‰∏≠‰ºòÂÖàÁ∫ß" } : priority)
                </span>
            </div>
            @if (!string.IsNullOrEmpty(dueDate))
            {
                <div class="task-due-date">
                    <span>üìÖ</span>
                    <span>@dueDate</span>
                </div>
            }
            @if (!string.IsNullOrEmpty(assignee))
            {
                <div class="task-assignee">
                    <span>üë§</span>
                    <span>@assignee</span>
                </div>
            }
        </div>
        }

        @if (!Model.Any())
        {
            <div class="empty-board">
                <div class="empty-icon">üìù</div>
                <h3>@(currentLang == "zh" ? "ÊöÇÊó†‰ªªÂä°" : "No tasks yet")</h3>
                <p>@(currentLang == "zh" ? "ÂàõÂª∫Á¨¨‰∏Ä‰∏™‰ªªÂä°ÂêßÔºÅ" : "Create your first task!")</p>
                <a href="/ui/Task/create?project=@currentProject" class="btn-create-empty">
                    <span>‚ûï</span> @(currentLang == "zh" ? "Êñ∞Âª∫‰ªªÂä°" : "New Task")
                </a>
            </div>
        }
    </div>

    <!-- ÂàÜÈ°µ -->
    @if (totalPages > 1)
    {
        <nav class="todo-pagination">
            @if (pageNum > 1)
            {
                <a href="/ui/Task?project=@currentProject&page=1" class="page-btn">¬´</a>
                <a href="/ui/Task?project=@currentProject&page=@(pageNum-1)" class="page-btn">‚Äπ</a>
            }
            <span class="page-info">@(currentLang == "zh" ? "Á¨¨" : "Page") @pageNum @(currentLang == "zh" ? "È°µÔºåÂÖ±" : "of") @totalPages @(currentLang == "zh" ? "È°µ" : "pages")</span>
            @if (pageNum < totalPages)
            {
                <a href="/ui/Task?project=@currentProject&page=@(pageNum+1)" class="page-btn">‚Ä∫</a>
                <a href="/ui/Task?project=@currentProject&page=@totalPages" class="page-btn">¬ª</a>
            }
        </nav>
    }
</div>

<style>
    .todo-app-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #f0fdf4 100%);
        min-height: 100vh;
    }

    .todo-header {
        background: linear-gradient(135deg, #059669 0%, #10b981 50%, #059669 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 40px rgba(5, 150, 105, 0.3);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1.5rem;
    }

    .app-title {
        color: white;
        font-size: 2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .title-icon {
        font-size: 2.5rem;
    }

    .stats-bar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .stat-badge {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        text-align: center;
        min-width: 80px;
    }

    .stat-number {
        display: block;
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
    }

    .stat-label {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .todo-toolbar {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .btn-new-task {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-new-task:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .search-form {
        display: flex;
        gap: 0.5rem;
    }

    .search-input {
        padding: 0.625rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        width: 280px;
        font-size: 0.875rem;
    }

    .search-input:focus {
        outline: none;
        border-color: #10b981;
    }

    .btn-search {
        padding: 0.625rem 1rem;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .task-board {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .task-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
        border-left: 4px solid #10b981;
    }

    .task-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    }

    .priority-high {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2, white);
    }

    .priority-medium {
        border-left-color: #f59e0b;
    }

    .priority-low {
        border-left-color: #10b981;
    }

    .task-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .task-id {
        font-size: 0.75rem;
        color: #9ca3af;
        font-weight: 600;
    }

    .task-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-edit, .btn-delete {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: #f3f4f6;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .btn-edit:hover {
        background: #3b82f6;
    }

    .btn-delete:hover {
        background: #ef4444;
    }

    .task-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
        line-height: 1.4;
    }

    .task-meta {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 0.75rem;
    }

    .task-status {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .task-status.pending { background: #fef3c7; color: #92400e; }
    .task-status.in_progress { background: #dbeafe; color: #1e40af; }
    .task-status.completed { background: #d1fae5; color: #065f46; }
    .task-status.blocked { background: #fee2e2; color: #991b1b; }

    .task-priority {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        background: #f3f4f6;
        color: #6b7280;
    }

    .task-due-date, .task-assignee {
        font-size: 0.875rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .empty-board {
        text-align: center;
        padding: 4rem 2rem;
        color: #9ca3af;
        grid-column: 1 / -1;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .btn-create-empty {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 1rem;
    }

    .todo-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        padding: 2rem 0;
    }

    .page-btn {
        padding: 0.625rem 1rem;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        color: #10b981;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s;
    }

    .page-btn:hover {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    .page-info {
        padding: 0.625rem 1rem;
        color: #6b7280;
        font-size: 0.875rem;
    }

    @@media (max-width: 768px) {
        .todo-app-container {
            padding: 1rem;
        }

        .header-content {
            flex-direction: column;
            align-items: stretch;
        }

        .stats-bar {
            justify-content: center;
        }

        .todo-toolbar {
            flex-direction: column;
            gap: 1rem;
        }

        .search-input {
            width: 100%;
        }

        .task-board {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.task-card');
        cards.forEach((card, index) => {
            card.style.animation = `fadeInUp 0.5s ease ${index * 0.1}s both`;
        });
    });
</script>
