@using Platform.Infrastructure.Definitions
@model IEnumerable<Dictionary<string, object>>
@{
    var def = (ModelDefinition)ViewData["ModelDef"]!;
    var modelName = (string)ViewData["ModelName"]!;
    var currentLang = Context.Request.Query["lang"].FirstOrDefault() ?? ViewData["Lang"] as string ?? "zh";

    var localizedLabels = currentLang == "zh"
        ? def.Ui?.Labels?.Zh
        : def.Ui?.Labels?.En;

    var title = localizedLabels != null && localizedLabels.ContainsKey("title")
        ? localizedLabels["title"]
        : modelName;

    ViewData["Title"] = title;
}

<style>
    .hmss-page-header {
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #212529;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .page-title i {
        color: #00A8E0;
    }

    .page-subtitle {
        color: #6c757d;
        font-size: 15px;
        margin: 0;
    }

    .hmss-data-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e9ecef;
    }

    .panel-title {
        font-size: 18px;
        font-weight: 600;
        color: #212529;
        margin: 0;
    }

    .panel-content {
        padding: 24px;
    }

    .hmss-table {
        width: 100%;
        border-collapse: collapse;
    }

    .hmss-table thead th {
        background: #f8f9fa;
        padding: 12px 16px;
        font-weight: 600;
        font-size: 14px;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
    }

    .hmss-table tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
    }

    .hmss-table tbody tr:hover {
        background: #f8f9fa;
    }

    .hmss-pagination {
        padding: 20px 24px;
        border-top: 1px solid #e9ecef;
    }
</style>

<div class="hmss-page-header">
    <h1 class="page-title">
        <i class="bi bi-list"></i>
        @title 管理
    </h1>
    <p class="page-subtitle">@title 数据列表</p>
</div>

<!-- 数据列表 -->
<div class="hmss-data-panel">
    <div class="panel-header">
        <h2 class="panel-title">@title 列表</h2>
        <div class="panel-actions">
            <a href="/ui/hmss/@modelName/create?project=hmss" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-lg"></i> @(localizedLabels?.GetValueOrDefault("create_button", "新增") ?? "新增")
            </a>
        </div>
    </div>
    <div class="panel-content">
        <div class="table-responsive">
            <table class="hmss-table" id="dataTable">
                <thead>
                    <tr>
                        @foreach (var col in def.List?.Columns ?? new List<string>())
                        {
                            var label = localizedLabels?.GetValueOrDefault(col.ToUpper(), col) ?? col;
                            <th>@label</th>
                        }
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="@(def.List?.Columns.Count + 1 ?? 1)" class="text-center py-5">暂无数据</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in Model)
                        {
                            <tr>
                                @foreach (var col in def.List?.Columns ?? new List<string>())
                                {
                                    var value = item.ContainsKey(col) ? item[col] : "";
                                    <td>@value</td>
                                }
                                <td class="text-center">
                                    <a href="/ui/hmss/@modelName/edit/@item[def.PrimaryKey]?project=hmss" class="btn btn-sm btn-outline-primary me-1">
                                        <i class="bi bi-pencil"></i> 编辑
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteItem('@item[def.PrimaryKey]')">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="hmss-pagination" id="pagination">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center" id="paginationUl">
                    @{
                        var page = (int)ViewData["Page"];
                        var size = (int)ViewData["Size"];
                        var total = (int)ViewData["Total"];
                        var totalPages = (int)Math.Ceiling((double)total / size);
                        
                        if (totalPages > 1)
                        {
                            <li class="page-item @(page <= 1 ? "disabled" : "")">
                                <a class="page-link" href="/ui/hmss/@modelName?page=@(page - 1)&size=@size&project=hmss">上一页</a>
                            </li>
                            
                            for (int i = 1; i <= totalPages; i++)
                            {
                                <li class="page-item @(i == page ? "active" : "")">
                                    <a class="page-link" href="/ui/hmss/@modelName?page=@i&size=@size&project=hmss">@i</a>
                                </li>
                            }

                            <li class="page-item @(page >= totalPages ? "disabled" : "")">
                                <a class="page-link" href="/ui/hmss/@modelName?page=@(page + 1)&size=@size&project=hmss">下一页</a>
                            </li>
                        }
                    }
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
    const modelName = '@modelName';
    const primaryKey = '@def.PrimaryKey';

    // 删除
    async function deleteItem(id) {
        if (!confirm('确定要删除这条记录吗？此操作不可恢复。')) {
            return;
        }

        try {
            // 获取 CSRF token
            const csrfToken = document.querySelector('#csrf-token')?.value || getCookie('XSRF-TOKEN');

            const response = await fetch(`/ui/hmss/${modelName}/delete/${id}?project=hmss`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': csrfToken
                }
            });

            if (response.ok) {
                alert('删除成功');
                location.reload();
            } else {
                const result = await response.json();
                alert('删除失败：' + (result.error || '未知错误'));
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('网络错误');
        }
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop()?.split(';').shift();
        return null;
    }
</script>
