@{
    ViewData["Title"] = "Weather App";
    ViewData["ActivePage"] = "Weather";
    var project = "weather";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸŒ¤ï¸ Weather - LowCode Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* åŠ¨æ€å¤©ç©ºèƒŒæ™¯ */
        @keyframes skyGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .sky-background {
            background: linear-gradient(-45deg, #1e3c72, #2a5298, #7e22ce, #0891b2, #1e3c72);
            background-size: 400% 400%;
            animation: skyGradient 15s ease infinite;
        }
        
        /* ç»ç’ƒæ€æ•ˆæœ */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* å¤©æ°”å›¾æ ‡åŠ¨ç”» */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .weather-icon {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 0 40px rgba(255,255,255,0.5); }
        }
        
        .temp-display {
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .loading {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* åŸå¸‚é€‰æ‹©å™¨ */
        .city-option {
            transition: all 0.3s ease;
        }
        
        .city-option:hover {
            background: rgba(255, 255, 255, 0.2);
            padding-left: 1.5rem;
        }
        
        /* é¢„æŠ¥å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .forecast-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .forecast-card:hover {
            transform: scale(1.05) translateY(-8px);
        }
    </style>
</head>
<body class="sky-background min-h-screen text-white">
    <!-- å¯¼èˆªæ  -->
    <nav class="glass sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center space-x-2 text-lg font-semibold hover:opacity-80 transition">
                    <span>ğŸ </span>
                    <span>LowCode Platform</span>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="/ui/City?project=weather" class="glass-card px-4 py-2 rounded-full text-sm hover:bg-white/20 transition">
                        ğŸ™ï¸ åŸå¸‚ç®¡ç†
                    </a>
                    <select id="city-selector" onchange="loadCityWeather(this.value, this.options[this.selectedIndex].text)" 
                            class="glass-card px-4 py-2 rounded-full text-sm bg-transparent cursor-pointer outline-none">
                        <option value="">é€‰æ‹©åŸå¸‚...</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- å½“å‰å¤©æ°”å¡ç‰‡ -->
        <div class="glass-card rounded-3xl p-8 mb-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-96 h-96 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
            <div class="relative z-10">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="text-center md:text-left mb-6 md:mb-0">
                        <h1 id="current-city" class="text-4xl font-bold mb-2">
                            <span class="loading">Loading...</span>
                        </h1>
                        <p id="current-date" class="text-white/70 text-lg"></p>
                        <div id="weather-status" class="mt-4 text-xl text-white/80"></div>
                    </div>
                    <div class="text-center">
                        <div id="current-icon" class="text-9xl weather-icon mb-4">ğŸŒ¤ï¸</div>
                        <div id="current-temp" class="text-8xl font-bold temp-display">
                            <span class="loading">--</span>Â°C
                        </div>
                        <div id="current-condition" class="text-2xl text-white/80 mt-2">--</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6 md:mt-0">
                        <div class="glass-card rounded-2xl p-4 text-center">
                            <div class="text-3xl mb-1">ğŸ’§</div>
                            <div id="current-humidity" class="text-xl font-semibold">--%</div>
                            <div class="text-sm text-white/60">æ¹¿åº¦</div>
                        </div>
                        <div class="glass-card rounded-2xl p-4 text-center">
                            <div class="text-3xl mb-1">ğŸ’¨</div>
                            <div id="current-wind" class="text-xl font-semibold">-- km/h</div>
                            <div class="text-sm text-white/60">é£é€Ÿ</div>
                        </div>
                        <div class="glass-card rounded-2xl p-4 text-center">
                            <div class="text-3xl mb-1">ğŸŒ¡ï¸</div>
                            <div id="current-feels" class="text-xl font-semibold">--Â°C</div>
                            <div class="text-sm text-white/60">ä½“æ„Ÿ</div>
                        </div>
                        <div class="glass-card rounded-2xl p-4 text-center">
                            <div class="text-3xl mb-1">ğŸ”µ</div>
                            <div id="current-pressure" class="text-xl font-semibold">-- hPa</div>
                            <div class="text-sm text-white/60">æ°”å‹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7 å¤©é¢„æŠ¥ -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="text-3xl mr-2">ğŸ“…</span>
                7 å¤©é¢„æŠ¥
            </h2>
            <div id="forecast-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å¤©æ°”è¯¦æƒ… -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="text-3xl mr-2">ğŸ“Š</span>
                å¤©æ°”è¯¦æƒ…
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-card rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-2">â˜€ï¸</div>
                    <div class="text-sm text-white/60 mb-1">ç´«å¤–çº¿æŒ‡æ•°</div>
                    <div id="detail-uv" class="text-2xl font-bold">--</div>
                </div>
                <div class="glass-card rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-2">ğŸŒ«ï¸</div>
                    <div class="text-sm text-white/60 mb-1">èƒ½è§åº¦</div>
                    <div id="detail-visibility" class="text-2xl font-bold">-- km</div>
                </div>
                <div class="glass-card rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-2">ğŸŒ…</div>
                    <div class="text-sm text-white/60 mb-1">æ—¥å‡º</div>
                    <div id="detail-sunrise" class="text-2xl font-bold">--:--</div>
                </div>
                <div class="glass-card rounded-2xl p-6 text-center">
                    <div class="text-4xl mb-2">ğŸŒ‡</div>
                    <div class="text-sm text-white/60 mb-1">æ—¥è½</div>
                    <div id="detail-sunset" class="text-2xl font-bold">--:--</div>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘è®°å½• -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="text-3xl mr-2">ğŸ“</span>
                æœ€è¿‘å¤©æ°”è®°å½•
            </h2>
            <div id="records-list" class="glass-card rounded-2xl overflow-hidden">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å¿«æ·æ“ä½œ -->
        <div>
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="text-3xl mr-2">âš¡</span>
                å¿«æ·æ“ä½œ
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="/ui/City?project=weather" 
                   class="glass-card rounded-2xl p-6 text-center group">
                    <div class="text-5xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ™ï¸</div>
                    <div class="font-semibold">æ·»åŠ åŸå¸‚</div>
                    <div class="text-sm text-white/60 mt-1">ç®¡ç†åŸå¸‚ä¿¡æ¯</div>
                </a>
                <a href="/ui/WeatherRecord?project=weather" 
                   class="glass-card rounded-2xl p-6 text-center group">
                    <div class="text-5xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸŒ¡ï¸</div>
                    <div class="font-semibold">è®°å½•å¤©æ°”</div>
                    <div class="text-sm text-white/60 mt-1">æ‰‹åŠ¨å½•å…¥æ•°æ®</div>
                </a>
                <a href="/ui/WeatherForecast?project=weather" 
                   class="glass-card rounded-2xl p-6 text-center group">
                    <div class="text-5xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ“…</div>
                    <div class="font-semibold">æŸ¥çœ‹é¢„æŠ¥</div>
                    <div class="text-sm text-white/60 mt-1">ç®¡ç†é¢„æŠ¥æ•°æ®</div>
                </a>
                <a href="/ui/WeatherCondition?project=weather" 
                   class="glass-card rounded-2xl p-6 text-center group">
                    <div class="text-5xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸŒ¦ï¸</div>
                    <div class="font-semibold">å¤©æ°”ä»£ç </div>
                    <div class="text-sm text-white/60 mt-1">æŸ¥çœ‹ä»£ç å®šä¹‰</div>
                </a>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="glass mt-16 py-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-white/60">
            <p>ğŸŒ¤ï¸ Weather App - Powered by OpenWeatherMap</p>
            <p class="text-sm mt-2">å®æ—¶å¤©æ°”æ•°æ® Â· 7 å¤©é¢„æŠ¥ Â· 20 ä¸ªåŸå¸‚</p>
        </div>
    </footer>

    <script>
        const API_BASE = '/api';
        let allCities = [];
        let currentCityId = null;

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            loadCities();
            loadWeatherConditions();
        });

        // åŠ è½½åŸå¸‚åˆ—è¡¨
        async function loadCities() {
            try {
                const response = await fetch(`${API_BASE}/weather/cities?project=weather`);
                const cities = await response.json();
                allCities = cities;
                
                // å¡«å……é€‰æ‹©å™¨
                const selector = document.getElementById('city-selector');
                selector.innerHTML = '<option value="">é€‰æ‹©åŸå¸‚...</option>' + 
                    cities.map(c => `<option value="${c.CityId}">${c.CityName} (${c.Country})</option>`).join('');
                
                // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªåŸå¸‚
                if (cities.length > 0) {
                    loadCityWeather(cities[0].CityId, cities[0].CityName);
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // åŠ è½½åŸå¸‚å¤©æ°”
        async function loadCityWeather(cityId, cityName) {
            currentCityId = cityId;
            
            document.getElementById('current-city').textContent = cityName;
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN', { 
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' 
            });
            
            await loadCurrentWeather(cityId);
            await loadForecast(cityId);
            await loadRecentRecords(cityId);
        }

        // åŠ è½½å½“å‰å¤©æ°”
        async function loadCurrentWeather(cityId) {
            try {
                const response = await fetch(`${API_BASE}/weather/current/${cityId}?project=weather`);
                const data = await response.json();
                
                if (data && (data.temperature !== undefined || data.Temperature !== undefined)) {
                    updateWeatherDisplay(data);
                }
            } catch (error) {
                console.error('Error loading weather:', error);
            }
        }

        // æ›´æ–°å¤©æ°”æ˜¾ç¤º
        function updateWeatherDisplay(record) {
            const temp = record.temperature || record.Temperature;
            const feels = record.feelsLike || record.FeelsLike;
            const humidity = record.humidity || record.Humidity;
            const wind = record.windSpeed || record.WindSpeed;
            const condition = record.weatherCondition || record.WeatherCondition;
            const code = record.weatherCode || record.WeatherCode;
            const uv = record.uvIndex || record.UVIndex;
            const visibility = record.visibility || record.Visibility;
            const pressure = record.pressure || record.Pressure;
            const sunrise = record.sunrise || record.Sunrise;
            const sunset = record.sunset || record.Sunset;
            
            document.getElementById('current-temp').textContent = `${Math.round(temp)}Â°C`;
            document.getElementById('current-condition').textContent = condition || '--';
            document.getElementById('current-humidity').textContent = `${humidity}%`;
            document.getElementById('current-wind').textContent = `${Math.round(wind)} km/h`;
            document.getElementById('current-feels').textContent = `${Math.round(feels || temp)}Â°C`;
            document.getElementById('current-pressure').textContent = `${Math.round(pressure)} hPa`;
            
            const icon = getWeatherIcon(code || condition);
            document.getElementById('current-icon').textContent = icon;
            document.getElementById('weather-status').textContent = `å®æ—¶æ•°æ® Â· æ›´æ–°äº ${record.updatedAt || 'åˆšåˆš'}`;
            
            document.getElementById('detail-uv').textContent = uv !== undefined ? uv : '--';
            document.getElementById('detail-visibility').textContent = `${visibility || '--'} km`;
            document.getElementById('detail-sunrise').textContent = sunrise || '--:--';
            document.getElementById('detail-sunset').textContent = sunset || '--:--';
        }

        // åŠ è½½å¤©æ°”é¢„æŠ¥
        async function loadForecast(cityId) {
            try {
                const response = await fetch(`${API_BASE}/weather/forecast/${cityId}?project=weather`);
                const forecasts = await response.json();
                
                if (forecasts && forecasts.length > 0) {
                    renderForecast(forecasts);
                }
            } catch (error) {
                console.error('Error loading forecast:', error);
            }
        }

        // æ¸²æŸ“å¤©æ°”é¢„æŠ¥
        function renderForecast(forecasts) {
            const container = document.getElementById('forecast-grid');
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const today = new Date();
            
            container.innerHTML = forecasts.map((f, i) => {
                const forecastDate = f.forecastDate || f.ForecastDate || f.date || f.Date;
                const tempMax = f.tempMax ?? f.TempMax ?? f.maxTemp;
                const tempMin = f.tempMin ?? f.TempMin ?? f.minTemp;
                const condition = f.weatherCondition ?? f.WeatherCondition ?? f.description;
                const code = f.weatherCode ?? f.WeatherCode ?? f.code;
                
                const date = forecastDate ? new Date(forecastDate) : new Date(today.getTime() + i * 86400000);
                const dayName = i === 0 ? 'ä»Šå¤©' : days[date.getDay()];
                const icon = getWeatherIcon(code || condition);
                
                return `
                    <div class="forecast-card glass-card rounded-2xl p-4 text-center cursor-pointer">
                        <div class="font-medium text-white/80 mb-2">${dayName}</div>
                        <div class="text-4xl mb-2">${icon}</div>
                        <div class="text-xs text-white/60 mb-2">${condition || '--'}</div>
                        <div class="flex justify-center space-x-2">
                            <span class="text-red-300 font-bold">${tempMax !== undefined ? Math.round(tempMax) : '--'}Â°</span>
                            <span class="text-blue-300">${tempMin !== undefined ? Math.round(tempMin) : '--'}Â°</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åŠ è½½æœ€è¿‘è®°å½•
        async function loadRecentRecords(cityId) {
            try {
                const response = await fetch(`${API_BASE}/weather/records/${cityId}?project=weather&limit=5`);
                const records = await response.json();
                
                if (Array.isArray(records) && records.length > 0) {
                    renderRecordsList(records);
                }
            } catch (error) {
                console.error('Error loading records:', error);
            }
        }

        // æ¸²æŸ“è®°å½•åˆ—è¡¨
        function renderRecordsList(records) {
            const container = document.getElementById('records-list');
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-white/10">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider">æ—¥æœŸ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider">å¤©æ°”</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider">æ¸©åº¦</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider">æ¹¿åº¦</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white/60 uppercase tracking-wider">é£é€Ÿ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/10">
                            ${records.map(r => {
                                const date = r.RecordDate || r.recordDate;
                                const temp = r.Temperature ?? r.temperature;
                                const humidity = r.Humidity ?? r.humidity;
                                const wind = r.WindSpeed ?? r.windSpeed;
                                const condition = r.WeatherCondition ?? r.weatherCondition;
                                const code = r.WeatherCode ?? r.weatherCode;
                                
                                return `
                                    <tr class="hover:bg-white/5 transition">
                                        <td class="px-6 py-4 whitespace-nowrap text-white/80">${date}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="text-xl mr-2">${getWeatherIcon(code || condition)}</span>
                                            ${condition || '--'}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap font-semibold">${temp !== undefined ? Math.round(temp) : '--'}Â°C</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${humidity !== undefined ? humidity : '--'}%</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${wind !== undefined ? Math.round(wind) : '--'} km/h</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // è·å–å¤©æ°”å›¾æ ‡
        function getWeatherIcon(condition) {
            const icons = {
                'clear': 'â˜€ï¸', 'Clear': 'â˜€ï¸', 'æ™´': 'â˜€ï¸',
                'cloudy': 'â˜ï¸', 'Clouds': 'â˜ï¸', 'å¤šäº‘': 'â˜ï¸',
                'partly_cloudy': 'â›…', 'partly cloudy': 'â›…', 'æ™´é—´å¤šäº‘': 'â›…',
                'overcast': 'ğŸŒ¥ï¸', 'é˜´å¤©': 'ğŸŒ¥ï¸',
                'rainy': 'ğŸŒ§ï¸', 'Rain': 'ğŸŒ§ï¸', 'ä¸‹é›¨': 'ğŸŒ§ï¸',
                'stormy': 'â›ˆï¸', 'Thunderstorm': 'â›ˆï¸', 'é›·é›¨': 'â›ˆï¸',
                'snowy': 'â„ï¸', 'Snow': 'â„ï¸', 'ä¸‹é›ª': 'â„ï¸',
                'foggy': 'ğŸŒ«ï¸', 'Mist': 'ğŸŒ«ï¸', 'æœ‰é›¾': 'ğŸŒ«ï¸',
                'windy': 'ğŸ’¨', 'Wind': 'ğŸ’¨', 'æœ‰é£': 'ğŸ’¨',
                'hail': 'ğŸŒ¨ï¸', 'Hail': 'ğŸŒ¨ï¸', 'å†°é›¹': 'ğŸŒ¨ï¸'
            };
            return icons[condition] || 'ğŸŒ¤ï¸';
        }

        // åŠ è½½å¤©æ°”æ¡ä»¶ï¼ˆé¢„åŠ è½½å›¾æ ‡æ˜ å°„ï¼‰
        async function loadWeatherConditions() {
            // é¢„ç•™æ‰©å±•åŠŸèƒ½
        }
    </script>
</body>
</html>
