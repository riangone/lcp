@{
    ViewData["Title"] = "Weather App";
    ViewData["ActivePage"] = "Weather";
    var project = "weather";
}

<div class="min-h-screen bg-gradient-to-br from-blue-50 via-cyan-50 to-indigo-50">
    <!-- é¡¶éƒ¨å¤©æ°”å¡ç‰‡ -->
    <div class="container mx-auto px-4 pt-8">
        <!-- æœ¬åœ°å¤©æ°”å¡ç‰‡ -->
        <div class="max-w-2xl mx-auto">
            <div class="bg-gradient-to-br from-blue-500 to-cyan-500 rounded-3xl shadow-2xl p-8 text-white mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-3xl font-bold" id="current-city">Loading...</h2>
                        <p class="text-blue-100" id="current-date">--</p>
                    </div>
                    <div class="text-6xl" id="current-icon">ğŸŒ¤ï¸</div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <div class="text-7xl font-bold" id="current-temp">--Â°</div>
                        <div class="text-xl text-blue-100" id="current-condition">--</div>
                    </div>
                    <div class="text-right space-y-2">
                        <div class="flex items-center space-x-2">
                            <span>ğŸ’§</span>
                            <span id="current-humidity">--%</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span>ğŸ’¨</span>
                            <span id="current-wind">-- km/h</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span>ğŸŒ¡ï¸</span>
                            <span id="current-feels">--Â°</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœç´¢æ  -->
        <div class="max-w-xl mx-auto mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-2 flex items-center space-x-2">
                <input type="text" id="city-search" 
                       placeholder="Search city..." 
                       class="flex-1 px-4 py-3 rounded-xl border-none focus:ring-2 focus:ring-blue-500 outline-none"
                       list="city-list">
                <datalist id="city-list"></datalist>
                <button onclick="searchCity()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-medium transition">
                    ğŸ” Search
                </button>
            </div>
        </div>

        <!-- 7 å¤©é¢„æŠ¥ -->
        <div class="max-w-5xl mx-auto mb-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">ğŸ“… 7-Day Forecast</h3>
            <div class="grid grid-cols-7 gap-3" id="forecast-grid">
                <!-- ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å¤©æ°”è¯¦æƒ…å¡ç‰‡ -->
        <div class="max-w-5xl mx-auto mb-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">ğŸ“Š Weather Details</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-2xl p-6 shadow-lg text-center">
                    <div class="text-3xl mb-2">â˜€ï¸</div>
                    <div class="text-sm text-gray-500">UV Index</div>
                    <div class="text-2xl font-bold text-gray-800" id="detail-uv">--</div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-lg text-center">
                    <div class="text-3xl mb-2">ğŸŒ«ï¸</div>
                    <div class="text-sm text-gray-500">Visibility</div>
                    <div class="text-2xl font-bold text-gray-800" id="detail-visibility">-- km</div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-lg text-center">
                    <div class="text-3xl mb-2">ğŸ”µ</div>
                    <div class="text-sm text-gray-500">Pressure</div>
                    <div class="text-2xl font-bold text-gray-800" id="detail-pressure">-- hPa</div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-lg text-center">
                    <div class="text-3xl mb-2">ğŸŒ…</div>
                    <div class="text-sm text-gray-500">Sunrise</div>
                    <div class="text-2xl font-bold text-gray-800" id="detail-sunrise">--:--</div>
                </div>
            </div>
        </div>

        <!-- åŸå¸‚åˆ—è¡¨ -->
        <div class="max-w-5xl mx-auto mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-800">ğŸ™ï¸ Managed Cities</h3>
                <a href="/ui/City?project=weather" class="text-blue-500 hover:underline">Manage â†’</a>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden" id="cities-list">
                <!-- ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æœ€è¿‘è®°å½• -->
        <div class="max-w-5xl mx-auto mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-800">ğŸ“ Recent Weather Records</h3>
                <a href="/ui/WeatherRecord?project=weather" class="text-blue-500 hover:underline">View All â†’</a>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden" id="records-list">
                <!-- ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å¿«æ·æ“ä½œ -->
        <div class="max-w-5xl mx-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">âš¡ Quick Actions</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="/ui/City?project=weather" 
                   class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition text-center group">
                    <div class="text-4xl mb-2 group-hover:scale-110 transition">ğŸ™ï¸</div>
                    <div class="font-medium text-gray-700">Add City</div>
                </a>
                <a href="/ui/WeatherRecord?project=weather" 
                   class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition text-center group">
                    <div class="text-4xl mb-2 group-hover:scale-110 transition">ğŸŒ¡ï¸</div>
                    <div class="font-medium text-gray-700">Record Weather</div>
                </a>
                <a href="/ui/WeatherForecast?project=weather" 
                   class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition text-center group">
                    <div class="text-4xl mb-2 group-hover:scale-110 transition">ğŸ“…</div>
                    <div class="font-medium text-gray-700">View Forecast</div>
                </a>
                <a href="/ui/WeatherCondition?project=weather" 
                   class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition text-center group">
                    <div class="text-4xl mb-2 group-hover:scale-110 transition">ğŸŒ¦ï¸</div>
                    <div class="font-medium text-gray-700">Weather Codes</div>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api';
    let allCities = [];
    let currentCityId = null;

    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        loadCities();
        loadWeatherConditions();
    });

    // åŠ è½½åŸå¸‚åˆ—è¡¨
    async function loadCities() {
        try {
            const response = await fetch(`${API_BASE}/City?project=weather`);
            const cities = await response.json();
            allCities = cities;
            
            // å¡«å…… datalist
            const datalist = document.getElementById('city-list');
            datalist.innerHTML = cities.map(c => 
                `<option value="${c.CityId}">${c.CityName} (${c.Country})</option>`
            ).join('');
            
            // æ˜¾ç¤ºåŸå¸‚åˆ—è¡¨
            renderCitiesList(cities.slice(0, 10));
            
            // åŠ è½½ç¬¬ä¸€ä¸ªåŸå¸‚çš„å¤©æ°”
            if (cities.length > 0) {
                loadCityWeather(cities[0].CityId, cities[0].CityName);
            }
        } catch (error) {
            console.error('Error loading cities:', error);
        }
    }

    // æ¸²æŸ“åŸå¸‚åˆ—è¡¨
    function renderCitiesList(cities) {
        const container = document.getElementById('cities-list');
        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">City</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Country</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Province</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timezone</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${cities.map(c => `
                            <tr class="hover:bg-gray-50 cursor-pointer" onclick="loadCityWeather(${c.CityId}, '${c.CityName}')">
                                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${c.CityName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500">${c.Country}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500">${c.Province || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500">${c.TimeZone || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // æœç´¢åŸå¸‚
    function searchCity() {
        const input = document.getElementById('city-search');
        const cityId = parseInt(input.value);
        
        if (cityId) {
            const city = allCities.find(c => c.CityId === cityId);
            if (city) {
                loadCityWeather(city.CityId, city.CityName);
            }
        } else {
            const cityName = input.value.toLowerCase();
            const city = allCities.find(c => c.CityName.toLowerCase().includes(cityName));
            if (city) {
                loadCityWeather(city.CityId, city.CityName);
            }
        }
    }

    // åŠ è½½åŸå¸‚å¤©æ°”
    async function loadCityWeather(cityId, cityName) {
        currentCityId = cityId;
        
        // æ›´æ–°å½“å‰åŸå¸‚æ˜¾ç¤º
        document.getElementById('current-city').textContent = cityName;
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
        
        // åŠ è½½å¤©æ°”è®°å½•
        await loadCurrentWeather(cityId);
        
        // åŠ è½½å¤©æ°”é¢„æŠ¥
        await loadForecast(cityId);
        
        // åŠ è½½æœ€è¿‘è®°å½•
        await loadRecentRecords(cityId);
    }

    // åŠ è½½å½“å‰å¤©æ°”
    async function loadCurrentWeather(cityId) {
        try {
            // ä½¿ç”¨å®æ—¶å¤©æ°” API
            const response = await fetch(`${API_BASE}/weather/current/${cityId}?project=weather`);
            const data = await response.json();
            
            if (data && data.Temperature !== undefined) {
                updateWeatherDisplay(data);
            }
        } catch (error) {
            console.error('Error loading weather:', error);
        }
    }

    // æ›´æ–°å¤©æ°”æ˜¾ç¤º
    function updateWeatherDisplay(record) {
        // æ”¯æŒå¤§å°å†™ä¸¤ç§å­—æ®µæ ¼å¼
        const temp = record.temperature || record.Temperature;
        const feels = record.feelsLike || record.FeelsLike;
        const humidity = record.humidity || record.Humidity;
        const wind = record.windSpeed || record.WindSpeed;
        const condition = record.weatherCondition || record.WeatherCondition;
        const code = record.weatherCode || record.WeatherCode;
        const uv = record.uvIndex || record.UVIndex;
        const visibility = record.visibility || record.Visibility;
        const pressure = record.pressure || record.Pressure;
        const sunrise = record.sunrise || record.Sunrise;
        const sunset = record.sunset || record.Sunset;
        
        document.getElementById('current-temp').textContent = `${temp}Â°C`;
        document.getElementById('current-condition').textContent = condition || '--';
        document.getElementById('current-humidity').textContent = `${humidity}%`;
        document.getElementById('current-wind').textContent = `${wind || 0} km/h`;
        document.getElementById('current-feels').textContent = `${feels || temp}Â°C`;
        
        // è®¾ç½®å¤©æ°”å›¾æ ‡
        const icon = getWeatherIcon(code || condition);
        document.getElementById('current-icon').textContent = icon;
        
        // æ›´æ–°è¯¦æƒ…
        document.getElementById('detail-uv').textContent = uv || '--';
        document.getElementById('detail-visibility').textContent = `${visibility || '--'} km`;
        document.getElementById('detail-pressure').textContent = `${pressure || '--'} hPa`;
        document.getElementById('detail-sunrise').textContent = sunrise || '--:--';
        document.getElementById('detail-sunset').textContent = sunset || '--:--';
    }

    // åŠ è½½å¤©æ°”é¢„æŠ¥
    async function loadForecast(cityId) {
        try {
            // ä½¿ç”¨å®æ—¶å¤©æ°”é¢„æŠ¥ API
            const response = await fetch(`${API_BASE}/weather/forecast/${cityId}?project=weather`);
            const forecasts = await response.json();
            
            if (forecasts && forecasts.length > 0) {
                renderForecast(forecasts);
            }
        } catch (error) {
            console.error('Error loading forecast:', error);
        }
    }

    // æ¸²æŸ“å¤©æ°”é¢„æŠ¥
    function renderForecast(forecasts) {
        const container = document.getElementById('forecast-grid');
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        container.innerHTML = forecasts.map(f => {
            // æ”¯æŒå¤§å°å†™ä¸¤ç§å­—æ®µæ ¼å¼
            const forecastDate = f.forecastDate || f.ForecastDate || f.date || f.Date;
            const tempMax = f.tempMax ?? f.TempMax ?? f.maxTemp ?? f.Tempmax;
            const tempMin = f.tempMin ?? f.TempMin ?? f.minTemp ?? f.Tempmin;
            const condition = f.weatherCondition ?? f.WeatherCondition ?? f.description ?? f.Description;
            const code = f.weatherCode ?? f.WeatherCode ?? f.code ?? f.Code;
            const precipProb = f.precipitationProbability ?? f.PrecipitationProbability ?? f.precipProb ?? 0;
            
            const date = forecastDate ? new Date(forecastDate) : new Date();
            const dayName = date.getDate() === new Date().getDate() ? 'Today' : days[date.getDay()];
            const icon = getWeatherIcon(code || condition);
            
            return `
                <div class="bg-white rounded-2xl p-4 shadow-lg text-center hover:shadow-xl transition">
                    <div class="font-medium text-gray-700 mb-2">${dayName}</div>
                    <div class="text-3xl mb-2">${icon}</div>
                    <div class="text-sm text-gray-500">${condition || '--'}</div>
                    <div class="flex justify-center space-x-2 mt-2">
                        <span class="text-red-500 font-bold">${tempMax !== undefined ? Math.round(tempMax) : '--'}Â°</span>
                        <span class="text-blue-500">${tempMin !== undefined ? Math.round(tempMin) : '--'}Â°</span>
                    </div>
                    ${precipProb ? `
                        <div class="text-xs text-blue-400 mt-1">ğŸ’§ ${precipProb}%</div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    // åŠ è½½æœ€è¿‘è®°å½•
    async function loadRecentRecords(cityId) {
        try {
            const response = await fetch(`${API_BASE}/weather/records/${cityId}?project=weather&limit=5`);
            const records = await response.json();
            
            if (Array.isArray(records) && records.length > 0) {
                const cityRecords = records
                    .sort((a, b) => new Date(b.RecordDate || b.recordDate) - new Date(a.RecordDate || a.recordDate))
                    .slice(0, 5);
                renderRecordsList(cityRecords);
            }
        } catch (error) {
            console.error('Error loading records:', error);
        }
    }

    // æ¸²æŸ“è®°å½•åˆ—è¡¨
    function renderRecordsList(records) {
        const container = document.getElementById('records-list');
        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Condition</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Temp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Humidity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wind</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${records.map(r => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900">${r.RecordDate}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${getWeatherIcon(r.WeatherCode || r.WeatherCondition)} ${r.WeatherCondition}</td>
                                <td class="px-6 py-4 whitespace-nowrap font-medium">${r.Temperature}Â°C</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.Humidity}%</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.WindSpeed || 0} km/h</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // åŠ è½½å¤©æ°”æ¡ä»¶
    async function loadWeatherConditions() {
        // é¢„åŠ è½½å¤©æ°”æ¡ä»¶ç”¨äºå›¾æ ‡æ˜ å°„
    }

    // è·å–å¤©æ°”å›¾æ ‡
    function getWeatherIcon(condition) {
        const icons = {
            'clear': 'â˜€ï¸',
            'æ™´æœ—': 'â˜€ï¸',
            'cloudy': 'â˜ï¸',
            'å¤šäº‘': 'â˜ï¸',
            'partly_cloudy': 'â›…',
            'æ™´é—´å¤šäº‘': 'â›…',
            'overcast': 'ğŸŒ¥ï¸',
            'é˜´å¤©': 'ğŸŒ¥ï¸',
            'rainy': 'ğŸŒ§ï¸',
            'ä¸‹é›¨': 'ğŸŒ§ï¸',
            'stormy': 'â›ˆï¸',
            'é›·é›¨': 'â›ˆï¸',
            'snowy': 'â„ï¸',
            'ä¸‹é›ª': 'â„ï¸',
            'foggy': 'ğŸŒ«ï¸',
            'æœ‰é›¾': 'ğŸŒ«ï¸',
            'windy': 'ğŸ’¨',
            'æœ‰é£': 'ğŸ’¨',
            'hail': 'ğŸŒ¨ï¸',
            'å†°é›¹': 'ğŸŒ¨ï¸'
        };
        return icons[condition] || 'ğŸŒ¤ï¸';
    }

    // å›è½¦æœç´¢
    document.getElementById('city-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchCity();
        }
    });
</script>
