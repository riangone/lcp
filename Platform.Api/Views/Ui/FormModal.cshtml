@using Platform.Infrastructure.Definitions
@{
    var def = (ModelDefinition)ViewData["ModelDef"]!;
    var modelName = (string)ViewData["ModelName"]!;
    var row = ViewData["Row"] as Dictionary<string, object>;
    var isEdit = row != null;

    // 获取当前语言，优先使用URL参数，否则使用ViewData中的值，默认为英文
    var currentLang = Context.Request.Query["lang"].FirstOrDefault() ?? ViewData["Lang"] as string ?? "en";
    var uiLabels = def.Ui?.Labels;
    Dictionary<string, string>? localizedLabels = null;
    
    if (uiLabels != null)
    {
        if (currentLang == "zh" && uiLabels.Zh != null)
        {
            localizedLabels = uiLabels.Zh;
        }
        else if (currentLang == "en" && uiLabels.En != null)
        {
            localizedLabels = uiLabels.En;
        }
    }
    
    if (localizedLabels == null)
    {
        localizedLabels = new Dictionary<string, string>();
    }
    
    var createLabel = localizedLabels.ContainsKey("create_form_title") ? localizedLabels["create_form_title"] : "Create";
    var editLabel = localizedLabels.ContainsKey("edit_form_title") ? localizedLabels["edit_form_title"] : "Edit";
    var saveLabel = localizedLabels.ContainsKey("save_button") ? localizedLabels["save_button"] : "Save";
    var cancelLabel = localizedLabels.ContainsKey("cancel_button") ? localizedLabels["cancel_button"] : "Cancel";
    var cardClass = def.Ui?.Styles?.CardClass ?? "card";
    var buttonClass = def.Ui?.Styles?.ButtonClass ?? "btn";

    var action = isEdit
        ? $"/api/{modelName}/{row![def.PrimaryKey]}"
        : $"/api/{modelName}";

    var method = isEdit ? "put" : "post";
}

<dialog open id="modal-form">
  <article class="@cardClass">
    <header>
      <button aria-label="Close" rel="prev" onclick="document.getElementById('modal-form').close(); return false;"></button>
      <h3>@(isEdit ? editLabel : createLabel) @modelName</h3>
    </header>

    <form method="post"
          @($"hx-{method}")="@action"
          hx-target="#list"
          hx-swap="innerHTML"
          hx-on="htmx:afterRequest: closeModalOnSuccess(event)">

        @foreach (var f in def.Form!.Fields)
        {
            var value = isEdit && row != null && row.ContainsKey(f.Key) ? row[f.Key]?.ToString() : "";
            
            // 获取本地化字段标签
            var fieldLabel = f.Value.Label;
            if(localizedLabels != null && localizedLabels.ContainsKey(f.Key))
            {
                fieldLabel = localizedLabels[f.Key];
            }

            <label>
              @fieldLabel

              @if (f.Value.Type == "select")
              {
                  <select name="@f.Key" @(f.Value.Required ? "required" : "")>
                    <option value="">--</option>
                    @if (f.Value.Options != null)
                    {
                        @foreach (var opt in f.Value.Options)
                        {
                            <option value="@opt.Key"
                                    @(value == opt.Key ? "selected" : "")>
                                @opt.Value
                            </option>
                        }
                    }
                  </select>
              }
              else
              {
                  var inputType = f.Value.Type == "decimal" ? "number" : f.Value.Type;
                  var step = f.Value.Type == "decimal" ? "step=\"0.01\"" : "";

                  <input
                    name="@f.Key"
                    type="@inputType"
                    @Html.Raw(step)
                    value="@value"
                    @(f.Value.Required ? "required" : "")
                    @(f.Value.MinLength.HasValue ? $"minlength=\"{f.Value.MinLength}\"" : "")
                    @(f.Value.MaxLength.HasValue ? $"maxlength=\"{f.Value.MaxLength}\"" : "")
                    @(f.Value.Min.HasValue ? $"min=\"{f.Value.Min}\"" : "")
                    @(f.Value.Max.HasValue ? $"max=\"{f.Value.Max}\"" : "") />
              }
            </label>
        }

      <footer>
        <button type="submit" class="@buttonClass">
        @if (localizedLabels != null && localizedLabels.ContainsKey("save_button"))
        {
            @localizedLabels["save_button"]
        }
        else
        {
            @:Save
        }
        </button>
        <button type="button" class="@buttonClass" onclick="document.getElementById('modal-form').close(); return false;">
        @if (localizedLabels != null && localizedLabels.ContainsKey("cancel_button"))
        {
            @localizedLabels["cancel_button"]
        }
        else
        {
            @:Cancel
        }
        </button>
      </footer>
    </form>
  </article>
</dialog>
