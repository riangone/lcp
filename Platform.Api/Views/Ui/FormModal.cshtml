@using Platform.Infrastructure.Definitions
@{
    var def = (ModelDefinition)ViewData["ModelDef"]!;
    var modelName = (string)ViewData["ModelName"]!;
    var row = ViewData["Row"] as Dictionary<string, object>;
    var isEdit = row != null;

    // 获取当前语言，优先使用URL参数，否则使用ViewData中的值，默认为英文
    var currentLang = Context.Request.Query["lang"].FirstOrDefault() ?? ViewData["Lang"] as string ?? "en";
    var uiLabels = def.Ui?.Labels;
    Dictionary<string, string>? localizedLabels = null;

    if (uiLabels != null)
    {
        if (currentLang == "zh" && uiLabels.Zh != null)
        {
            localizedLabels = uiLabels.Zh;
        }
        else if (currentLang == "en" && uiLabels.En != null)
        {
            localizedLabels = uiLabels.En;
        }
    }

    if (localizedLabels == null)
    {
        localizedLabels = new Dictionary<string, string>();
    }

    var createLabel = localizedLabels.ContainsKey("create_form_title") ? localizedLabels["create_form_title"] : "Create";
    var editLabel = localizedLabels.ContainsKey("edit_form_title") ? localizedLabels["edit_form_title"] : "Edit";
    var saveLabel = localizedLabels.ContainsKey("save_button") ? localizedLabels["save_button"] : "Save";
    var cancelLabel = localizedLabels.ContainsKey("cancel_button") ? localizedLabels["cancel_button"] : "Cancel";
    var cardClass = def.Ui?.Styles?.CardClass ?? "card";
    var buttonClass = def.Ui?.Styles?.ButtonClass ?? "btn";

    var action = isEdit
        ? $"/api/{modelName}/{row![def.PrimaryKey]}"
        : $"/api/{modelName}";

    var method = isEdit ? "put" : "post";
}

<div id="modal-form" class="fixed inset-0 bg-black bg-opacity-50 flex items-start md:items-center justify-center z-[1300] p-4 pt-20 md:pt-4 overflow-auto">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-auto my-4 max-h-[calc(100dvh-6rem)] md:max-h-[90vh] overflow-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">
          @(isEdit ? editLabel : createLabel) @modelName
        </h3>
        <button class="text-gray-500 hover:text-gray-700"
                onclick="document.getElementById('modal-form').remove(); return false;">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form method="post"
            @($"hx-{method}")="@action"
            hx-target="#list"
            hx-swap="innerHTML"
            hx-on="htmx:afterRequest: closeModalOnSuccess(event)"
            class="space-y-4">
        @Html.AntiForgeryToken()

          @foreach (var f in def.Form!.Fields)
          {
              var value = isEdit && row != null && row.ContainsKey(f.Key) ? row[f.Key]?.ToString() : "";

              // 获取本地化字段标签
              var fieldLabel = f.Value.Label;
              if(localizedLabels != null && localizedLabels.ContainsKey(f.Key))
              {
                  fieldLabel = localizedLabels[f.Key];
              }

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  @fieldLabel @(f.Value.Required ? "*" : "")
                </label>

                @if (f.Value.Type == "select")
                {
                    <select name="@f.Key"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            @(f.Value.Required ? "required" : "")>
                      <option value="">Select...</option>
                      @if (f.Value.Options != null)
                      {
                          @foreach (var opt in f.Value.Options)
                          {
                              <option value="@opt.Key"
                                      @(value == opt.Key ? "selected" : "")>
                                  @opt.Value
                              </option>
                          }
                      }
                    </select>
                }
                else
                {
                    var inputType = f.Value.Type == "decimal" ? "number" : f.Value.Type;
                    var step = f.Value.Type == "decimal" ? "step=\"0.01\"" : "";

                    <input
                      name="@f.Key"
                      type="@inputType"
                      @Html.Raw(step)
                      value="@value"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      @(f.Value.Required ? "required" : "")
                      @(f.Value.MinLength.HasValue ? $"minlength=\"{f.Value.MinLength}\"" : "")
                      @(f.Value.MaxLength.HasValue ? $"maxlength=\"{f.Value.MaxLength}\"" : "")
                      @(f.Value.Min.HasValue ? $"min=\"{f.Value.Min}\"" : "")
                      @(f.Value.Max.HasValue ? $"max=\"{f.Value.Max}\"" : "") />
                }
              </div>
          }

        <div class="flex justify-end space-x-3 pt-4">
          <button type="button"
                  class="btn btn-outline"
                  onclick="document.getElementById('modal-form').remove(); return false;">
            <i class="fas fa-times mr-2"></i>@cancelLabel
          </button>
          <button type="submit"
                  class="btn btn-primary">
            <i class="fas fa-save mr-2"></i>@saveLabel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // 关闭模态框时移除DOM
  function closeFormModal() {
    var modal = document.getElementById('modal-form');
    if(modal) {
      modal.remove();
    }
  }

  // 更新closeModalOnSuccess函数
  function closeModalOnSuccess(event) {
    // Close modal only if the request was successful (status 200-299)
    if (event.detail.xhr.status >= 200 && event.detail.xhr.status < 300) {
      closeFormModal();
    }
  }

  // ESC键关闭模态框
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      var modal = document.getElementById('modal-form');
      if(modal) {
        modal.remove();
      }
    }
  });

  // 点击模态框外部关闭
  document.getElementById('modal-form').addEventListener('click', function(event) {
    if (event.target === this) {
      this.remove();
    }
  });

  // 自动添加CSRF令牌到htmx请求
  document.addEventListener('htmx:configRequest', function(evt) {
    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
    if(token) {
      evt.detail.parameters['__RequestVerificationToken'] = token;
    }
  });
</script>
