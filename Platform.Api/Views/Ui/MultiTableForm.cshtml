@using Platform.Infrastructure.Definitions
@{
    var pageDef = (PageDefinition)ViewData["PageDef"]!;
    var pageName = (string)ViewData["PageName"]!;
    var currentLang = Context.Request.Query["lang"].FirstOrDefault() ?? ViewData["Lang"] as string ?? "en";
    
    var title = pageDef.Title ?? pageName;
    ViewData["Title"] = $"{title} - Low Code Platform";
    ViewData["ActivePage"] = "Page";
    ViewData["Lang"] = currentLang;
}

<div class="container mx-auto px-4 py-8">
    @* 页面标题 *@
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">@title</h1>
        @if (!string.IsNullOrEmpty(pageDef.Description))
        {
            <p class="text-gray-600">@pageDef.Description</p>
        }
    </div>

    @* 多表 CRUD 表单 *@
    @if (pageDef.MultiTableCrud != null)
    {
        var mainTable = pageDef.MultiTableCrud.MainTable;
        var relatedTables = pageDef.MultiTableCrud.RelatedTables;
        var formMapping = pageDef.MultiTableCrud.FormMapping;

        <div class="card">
            <div class="card-header border-b border-gray-200 pb-4 mb-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-edit mr-2"></i>@(mainTable?.Table ?? "Form")
                </h2>
            </div>

            <form id="multi-table-form" class="space-y-6">
                @Html.AntiForgeryToken()
                <input type="hidden" id="edit-id" name="id" value="" />

                @* 主表字段 *@
                @if (mainTable != null && formMapping.ContainsKey(mainTable.Table))
                {
                    var mainFields = formMapping[mainTable.Table];
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        @foreach (var field in mainFields)
                        {
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    @field.Label
                                    @if (field.Required)
                                    {
                                        <span class="text-red-500">*</span>
                                    }
                                </label>
                                
                                @if (field.Type == "date")
                                {
                                    <input type="date" name="@field.Field" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           @(field.Required ? "required" : "") />
                                }
                                else if (field.Type == "number" || field.Type == "decimal")
                                {
                                    <input type="number" step="0.01" name="@field.Field" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           @(field.Required ? "required" : "") />
                                }
                                else if (field.Type == "select" && field.Options != null)
                                {
                                    <select name="@field.Field" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            @(field.Required ? "required" : "")>
                                        <option value="">请选择</option>
                                        @foreach (var opt in field.Options)
                                        {
                                            <option value="@opt.Key">@opt.Value</option>
                                        }
                                    </select>
                                }
                                else
                                {
                                    <input type="text" name="@field.Field" maxlength="@(field.MaxLength ?? 100)"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           @(field.Required ? "required" : "") />
                                }
                            </div>
                        }
                    </div>
                }

                @* 关联表字段（一对多） *@
                @foreach (var relatedTable in relatedTables.Where(t => t.Type == "many"))
                {
                    if (formMapping.ContainsKey(relatedTable.Table))
                    {
                        var tableFields = formMapping[relatedTable.Table];
                        var tableName = relatedTable.Table;
                        
                        <div class="border-t border-gray-200 pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-list mr-2"></i>@relatedTable.Table
                                </h3>
                                <button type="button" onclick="addRow('@tableName')" 
                                        class="btn btn-success btn-sm">
                                    <i class="fas fa-plus mr-1"></i>添加明细
                                </button>
                            </div>
                            
                            <div id="@tableName-rows" class="space-y-4">
                                @* 动态添加的行将放在这里 *@
                            </div>
                            
                            @* 行模板（隐藏） *@
                            <template id="@tableName-template">
                                <div class="@(tableName)-row border rounded-lg p-4 bg-gray-50 relative">
                                    <button type="button" onclick="removeRow(this)" 
                                            class="absolute top-2 right-2 text-red-500 hover:text-red-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        @foreach (var field in tableFields)
                                        {
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    @field.Label
                                                    @if (field.Required)
                                                    {
                                                        <span class="text-red-500">*</span>
                                                    }
                                                </label>
                                                
                                                @if (field.Type == "number" || field.Type == "decimal")
                                                {
                                                    <input type="number" step="0.01" 
                                                           name="@(tableName)[{index}].@(field.Field)" 
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                           @(field.Required ? "required" : "") 
                                                           value="@(field.Default ?? "")" />
                                                }
                                                else
                                                {
                                                    <input type="text" 
                                                           name="@(tableName)[{index}].@(field.Field)" 
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                           @(field.Required ? "required" : "") 
                                                           value="@(field.Default ?? "")" />
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </template>
                        </div>
                    }
                }

                @* 表单按钮 *@
                <div class="flex gap-3 pt-6 border-t border-gray-200">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                    <button type="button" onclick="resetForm()" class="btn btn-outline">
                        <i class="fas fa-undo mr-2"></i>重置
                    </button>
                    <button type="button" onclick="deleteCurrent()" id="delete-btn" class="btn btn-danger hidden">
                        <i class="fas fa-trash mr-2"></i>删除
                    </button>
                </div>
            </form>
        </div>

        @* 数据列表 *@
        <div class="card mt-6">
            <div class="card-header border-b border-gray-200 pb-4 mb-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-list mr-2"></i>数据列表
                </h2>
            </div>

            @* 分页控制 - 每页大小 *@
            <div class="flex items-center justify-between mb-4 px-6">
                <div class="flex items-center gap-4">
                    <label class="text-sm text-gray-600" for="page-size-select">每页显示:</label>
                    <select id="page-size-select" class="border border-gray-300 rounded-lg px-2 py-1 text-sm" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="text-sm text-gray-700">
                    共 <span id="total-count" class="font-medium">0</span> 条记录
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            @if (mainTable != null && formMapping.ContainsKey(mainTable.Table))
                            {
                                var mainFields = formMapping[mainTable.Table];
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">@mainTable.PrimaryKey</th>
                                foreach (var field in mainFields)
                                {
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">@field.Label</th>
                                }
                            }
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="data-list-body" class="bg-white divide-y divide-gray-200">
                        @* 数据将通过 JS 加载 *@
                    </tbody>
                </table>
            </div>

            @* 分页导航 - 与_ListContent 样式统一 *@
            <nav id="pagination" class="flex items-center justify-between border-t border-gray-200 px-4 py-3 sm:px-6 mt-6" style="display: none;">
                <div class="flex flex-1 justify-between sm:hidden">
                    <button id="mobile-prev-btn" class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" onclick="goToPage(currentPage - 1)">
                        Previous
                    </button>
                    <button id="mobile-next-btn" class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" onclick="goToPage(currentPage + 1)">
                        Next
                    </button>
                </div>
                <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Showing page <span id="current-page-num" class="font-medium">1</span> of <span id="total-pages-num" class="font-medium">1</span>,
                            <span id="total-records" class="font-medium">0</span> records
                        </p>
                    </div>
                    <div>
                        <nav id="page-numbers" class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                            <!-- 页码按钮将动态生成 -->
                        </nav>
                    </div>
                </div>
            </nav>
        </div>
    }
    else
    {
        <div class="text-center py-12">
            <i class="fas fa-exclamation-circle text-6xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">此页面未配置多表 CRUD</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        let rowIndex = 0;
        let currentEditId = null;
        const pageName = '@pageName';
        const mainTable = '@(pageDef.MultiTableCrud?.MainTable?.Table ?? "")';
        const mainFields = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            pageDef.MultiTableCrud?.FormMapping?.GetValueOrDefault(pageDef.MultiTableCrud?.MainTable?.Table ?? "")
                ?.Select(f => new { Field = f.Field, Label = f.Label })
                ?? Enumerable.Empty<object>()
        ));

        // 分页变量
        let currentPage = 1;
        let pageSize = 10;
        let totalCount = 0;
        let totalPages = 1;

        // 添加新行
        function addRow(tableName) {
            const template = document.getElementById(`${tableName}-template`);
            const container = document.getElementById(`${tableName}-rows`);

            if (!template || !container) return;

            const clone = template.content.cloneNode(true);
            const rowDiv = clone.querySelector(`.${tableName}-row`);

            if (!rowDiv) return;

            // 替换所有占位符 {index} 为实际索引
            rowDiv.innerHTML = rowDiv.innerHTML.replace(/{index}/g, rowIndex);

            // 设置 input 的 name 属性
            rowDiv.querySelectorAll('input').forEach(input => {
                const name = input.getAttribute('name');
                if (name) {
                    input.setAttribute('name', name.replace('{index}', rowIndex));
                }
            });

            container.appendChild(rowDiv);
            rowIndex++;
        }

        // 删除行
        function removeRow(btn) {
            const row = btn.closest(`.${btn.className.split(' ').find(c => c.endsWith('-row'))}`);
            if (row) {
                row.remove();
            }
        }

        // 重置表单
        function resetForm() {
            document.getElementById('multi-table-form').reset();
            document.querySelectorAll('[id$="-rows"]').forEach(el => el.innerHTML = '');
            document.getElementById('edit-id').value = '';
            currentEditId = null;
            document.getElementById('delete-btn').classList.add('hidden');
        }

        // 改变每页大小
        function changePageSize() {
            const select = document.getElementById('page-size-select');
            pageSize = parseInt(select.value);
            currentPage = 1;
            loadData();
        }

        // 跳转到指定页
        function goToPage(page) {
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            if (page === currentPage) return;
            currentPage = page;
            loadData();
        }

        // 生成页码按钮 HTML
        function renderPageNumbers() {
            const container = document.getElementById('page-numbers');
            if (!container) return;

            let html = '';

            // 首页按钮
            if (currentPage > 1) {
                html += `<button class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" onclick="goToPage(1)">
                    <span class="sr-only">First</span>
                    <i class="fas fa-angles-left h-5 w-5"></i>
                </button>`;
                html += `<button class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" onclick="goToPage(currentPage - 1)">
                    <span class="sr-only">Previous</span>
                    <i class="fas fa-chevron-left h-5 w-5"></i>
                </button>`;
            } else {
                html += `<button disabled class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 opacity-50 cursor-not-allowed">
                    <i class="fas fa-angles-left h-5 w-5"></i>
                </button>`;
                html += `<button disabled class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 opacity-50 cursor-not-allowed">
                    <i class="fas fa-chevron-left h-5 w-5"></i>
                </button>`;
            }

            // 页码按钮（显示当前页前后 2 页）
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<button aria-current="page" class="relative z-10 inline-flex items-center bg-blue-600 px-4 py-2 text-sm font-semibold text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">
                        ${i}
                    </button>`;
                } else {
                    html += `<button class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" onclick="goToPage(${i})">
                        ${i}
                    </button>`;
                }
            }

            // 末页按钮
            if (currentPage < totalPages) {
                html += `<button class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" onclick="goToPage(currentPage + 1)">
                    <span class="sr-only">Next</span>
                    <i class="fas fa-chevron-right h-5 w-5"></i>
                </button>`;
                html += `<button class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0" onclick="goToPage(totalPages)">
                    <span class="sr-only">Last</span>
                    <i class="fas fa-angles-right h-5 w-5"></i>
                </button>`;
            } else {
                html += `<button disabled class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 opacity-50 cursor-not-allowed">
                    <i class="fas fa-chevron-right h-5 w-5"></i>
                </button>`;
                html += `<button disabled class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 opacity-50 cursor-not-allowed">
                    <i class="fas fa-angles-right h-5 w-5"></i>
                </button>`;
            }

            container.innerHTML = html;
        }

        // 更新分页 UI
        function updatePagination() {
            // 更新统计信息
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('current-page-num').textContent = currentPage;
            document.getElementById('total-pages-num').textContent = totalPages;
            document.getElementById('total-records').textContent = totalCount;

            // 更新移动端按钮状态
            const mobilePrev = document.getElementById('mobile-prev-btn');
            const mobileNext = document.getElementById('mobile-next-btn');
            if (mobilePrev) mobilePrev.disabled = currentPage === 1;
            if (mobileNext) mobileNext.disabled = currentPage === totalPages;

            // 显示/隐藏分页导航
            const pagination = document.getElementById('pagination');
            if (pagination) {
                pagination.style.display = totalPages > 1 ? 'flex' : 'none';
            }

            // 生成页码按钮
            renderPageNumbers();
        }

        // 保存表单
        document.getElementById('multi-table-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = new URLSearchParams();

            // 收集所有表单数据
            for (const [key, value] of formData.entries()) {
                if (key === '__RequestVerificationToken') continue;
                if (value && value.trim() !== '') {
                    data.append(key, value);
                }
            }

            const id = document.getElementById('edit-id').value;
            const url = id
                ? `/page/${pageName}/multi-table/save?id=${encodeURIComponent(id)}`
                : `/page/${pageName}/multi-table/save`;

            console.log('Submitting to:', url);
            console.log('Data:', data.toString());

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: data.toString()
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || '请求失败');
                }

                const result = await response.json();

                if (result.success) {
                    alert(result.message || '保存成功');
                    if (id) {
                        loadData();
                    } else {
                        resetForm();
                        loadData();
                    }
                } else {
                    alert('错误：' + result.message);
                }
            } catch (err) {
                console.error('保存失败:', err);
                alert('保存失败：' + err.message);
            }
        });

        // 加载数据列表（带分页）
        async function loadData() {
            try {
                const offset = (currentPage - 1) * pageSize;
                const response = await fetch(`/page/${pageName}/multi-table-data?page=${currentPage}&size=${pageSize}&offset=${offset}`);
                const result = await response.json();

                const tbody = document.getElementById('data-list-body');
                tbody.innerHTML = '';

                if (result.success && result.data && result.data.length > 0) {
                    // 更新总数
                    totalCount = result.total || result.data.length;
                    totalPages = Math.ceil(totalCount / pageSize);

                    result.data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-50 transition-colors';

                        // 动态生成表格行
                        let cellsHtml = '';

                        // 主键列 - 尝试多种可能的键名
                        const pkValue = item[mainTable.toLowerCase() + 'id'] 
                            || item['InvoiceId'] 
                            || item['Id'] 
                            || item['id'] 
                            || item[Object.keys(item)[0]] // 使用第一个字段作为备选
                            || '';
                        
                        console.log('生成行，item:', item, 'pkValue:', pkValue);
                        
                        cellsHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${pkValue}</td>`;

                        // 动态字段列
                        mainFields.forEach(field => {
                            const fieldName = field.Field;
                            const camelCaseName = fieldName.charAt(0).toLowerCase() + fieldName.slice(1);
                            const value = item[camelCaseName] || item[fieldName] || item[fieldName.toLowerCase()] || '';
                            cellsHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${value}</td>`;
                        });

                        // 操作列 - 使用 data 属性而不是 onclick
                        cellsHtml += `
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button class="edit-btn text-blue-600 hover:text-blue-900 mr-3" data-id="${pkValue}">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="delete-btn text-red-600 hover:text-red-900" data-id="${pkValue}">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </td>
                        `;

                        tr.innerHTML = cellsHtml;
                        tbody.appendChild(tr);
                    });
                } else {
                    totalCount = 0;
                    totalPages = 1;
                    tbody.innerHTML = '<tr><td colspan="' + (mainFields.length + 2) + '" class="text-center py-8 text-gray-500">暂无数据</td></tr>';
                }

                updatePagination();
            } catch (err) {
                console.error('加载数据失败:', err);
                totalCount = 0;
                totalPages = 1;
                updatePagination();
            }
        }

        // 编辑项目
        async function editItem(id) {
            console.log('=== 开始编辑 ===');
            console.log('ID:', id);
            console.log('pageName:', pageName);
            console.log('mainTable:', mainTable);
            console.log('mainFields:', mainFields);
            
            try {
                const url = `/page/${pageName}/multi-table/${id}`;
                console.log('请求 URL:', url);
                
                const response = await fetch(url);
                console.log('响应状态:', response.status);
                
                const result = await response.json();
                console.log('完整响应:', JSON.stringify(result, null, 2));
                console.log('result.success:', result.success);
                console.log('result.data:', result.data);
                console.log('result.data 类型:', typeof result.data);
                console.log('result.data 键名:', Object.keys(result.data || {}));

                if (result.success) {
                    const data = result.data;
                    
                    console.log('data 对象:', data);
                    console.log('data 键名:', Object.keys(data || {}));
                    
                    // 尝试不同的键名获取主表数据
                    let mainData = {};
                    if (data[mainTable] && Array.isArray(data[mainTable]) && data[mainTable].length > 0) {
                        mainData = data[mainTable][0];
                    } else if (data['Invoice'] && Array.isArray(data['Invoice']) && data['Invoice'].length > 0) {
                        mainData = data['Invoice'][0];
                    } else if (data['invoice'] && Array.isArray(data['invoice']) && data['invoice'].length > 0) {
                        mainData = data['invoice'][0];
                    } else {
                        // 如果都没有，尝试从 data 中直接获取字段
                        mainData = data;
                    }
                    
                    console.log('使用的 mainData:', mainData);
                    console.log('mainData 键名:', Object.keys(mainData || {}));

                    // 填充主表字段
                    const idField = document.getElementById('edit-id');
                    if (idField) {
                        idField.value = mainData.InvoiceId || mainData[mainTable + 'Id'] || mainData['InvoiceId'] || id;
                        console.log('设置 ID 字段:', idField.value);
                    }

                    // 遍历所有字段配置进行填充
                    for (const field of mainFields) {
                        const fieldName = field.Field;
                        const value = mainData[fieldName];
                        console.log(`字段 ${fieldName}:`, value);

                        if (value !== undefined && value !== null && value !== '') {
                            const input = document.querySelector(`input[name="${fieldName}"]`);
                            console.log(`  输入框 ${fieldName}:`, input ? '找到' : '未找到');
                            
                            if (input) {
                                // 处理日期格式
                                if (input.type === 'date' && typeof value === 'string') {
                                    const dateValue = value.split(' ')[0]; // 只取日期部分
                                    input.value = dateValue;
                                    console.log(`  设置日期 ${fieldName}: ${dateValue}`);
                                } else {
                                    input.value = value;
                                    console.log(`  设置值 ${fieldName}: ${value}`);
                                }
                            }
                        }
                    }

                    // 填充关联表数据
                    const relatedTableName = 'InvoiceLine';
                    const relatedData = data[relatedTableName] || data['invoiceline'] || [];
                    console.log('明细数据:', relatedData);
                    
                    if (relatedData.length > 0) {
                        const container = document.getElementById(`${relatedTableName}-rows`);
                        console.log('容器:', container);
                        
                        if (container) {
                            container.innerHTML = '';
                            
                            relatedData.forEach((row, index) => {
                                addRow(relatedTableName);
                                console.log(`添加行 ${index}:`, row);

                                // 填充行数据
                                const rows = container.querySelectorAll(`.${relatedTableName}-row`);
                                const currentRow = rows[rows.length - 1];
                                if (currentRow) {
                                    for (const [key, value] of Object.entries(row)) {
                                        const input = currentRow.querySelector(`input[name*="${key}"]`);
                                        if (input) {
                                            input.value = value;
                                            console.log(`  设置明细 ${key}: ${value}`);
                                        }
                                    }
                                }
                            });
                        }
                    }

                    currentEditId = id;
                    document.getElementById('delete-btn').classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    console.log('=== 编辑加载完成 ===');
                } else {
                    alert('加载数据失败：' + (result.message || '未知错误'));
                }
            } catch (err) {
                console.error('编辑加载失败:', err);
                alert('加载数据失败：' + err.message);
            }
        }

        // 删除项目
        async function deleteItem(id) {
            if (!confirm('确定要删除这条记录吗？')) return;
            
            try {
                const formData = new FormData();
                formData.append('id', id);
                
                const response = await fetch(`/page/${pageName}/multi-table/delete`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('删除成功');
                    loadData();
                    if (currentEditId === id) {
                        resetForm();
                    }
                } else {
                    alert('删除失败：' + result.message);
                }
            } catch (err) {
                alert('删除失败：' + err.message);
            }
        }

        // 删除当前编辑的项目
        function deleteCurrent() {
            if (currentEditId) {
                deleteItem(currentEditId);
            }
        }

        // 页面加载时加载数据
        loadData();

        // 事件委托 - 处理编辑和删除按钮点击
        document.addEventListener('click', function(e) {
            // 使用 closest 向上查找，因为点击的可能是按钮内的图标
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (editBtn) {
                const id = editBtn.getAttribute('data-id');
                console.log('点击编辑按钮，data-id:', id, 'element:', editBtn);
                if (id) {
                    editItem(parseInt(id));
                } else {
                    console.error('未找到 data-id 属性');
                }
                return;
            }

            if (deleteBtn) {
                const id = deleteBtn.getAttribute('data-id');
                console.log('点击删除按钮，data-id:', id, 'element:', deleteBtn);
                if (id) {
                    deleteItem(parseInt(id));
                } else {
                    console.error('未找到 data-id 属性');
                }
            }
        });
    </script>
}
