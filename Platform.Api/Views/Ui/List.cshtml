@using Platform.Infrastructure.Definitions
@model IEnumerable<Dictionary<string, object>>
@{
    var def = (ModelDefinition)ViewData["ModelDef"]!;
    var modelName = (string)ViewData["ModelName"]!;
    var pageNum =  (int)ViewData["Page"]!;
    var size = (int)ViewData["Size"]!;
    var total = (int)ViewData["Total"]!;
    var totalPages = (int)Math.Ceiling((double)total / size);
    
    string RenderValue(ModelDefinition def, string col, object val)
    {
        if (def.Form != null
            && def.Form.Fields.TryGetValue(col, out var f)
            && f.Type == "select"
            && f.Options != null
            && f.Options.TryGetValue(val.ToString()!, out var label))
        {
            return label;
        }
        return val?.ToString() ?? "";
    }
}

@{
    // Ëé∑ÂèñÂΩìÂâçËØ≠Ë®ÄÔºå‰ºòÂÖà‰ΩøÁî®URLÂèÇÊï∞ÔºåÂê¶Âàô‰ΩøÁî®ViewData‰∏≠ÁöÑÂÄºÔºåÈªòËÆ§‰∏∫Ëã±Êñá
    var currentLang = Context.Request.Query["lang"].FirstOrDefault() ?? ViewData["Lang"] as string ?? "en";
    var uiLabels = def.Ui?.Labels;
    Dictionary<string, string>? localizedLabels = null;
    
    if (uiLabels != null)
    {
        if (currentLang == "zh" && uiLabels.Zh != null)
        {
            localizedLabels = uiLabels.Zh;
        }
        else if (currentLang == "en" && uiLabels.En != null)
        {
            localizedLabels = uiLabels.En;
        }
    }
    
    if (localizedLabels == null)
    {
        localizedLabels = new Dictionary<string, string>();
    }
    
    var title = localizedLabels.ContainsKey("title") ? localizedLabels["title"] : modelName;
    var createButtonLabel = localizedLabels.ContainsKey("create_button") ? localizedLabels["create_button"] : "Add " + modelName;
    var filterButtonLabel = localizedLabels.ContainsKey("filter_button") ? localizedLabels["filter_button"] : "Filter";
    var clearButtonLabel = localizedLabels.ContainsKey("clear_button") ? localizedLabels["clear_button"] : "Clear";
    var searchPlaceholder = localizedLabels.ContainsKey("search_placeholder") ? localizedLabels["search_placeholder"] : "Search...";
    var cardClass = def.Ui?.Styles?.CardClass ?? "card";
    var buttonClass = def.Ui?.Styles?.ButtonClass ?? "btn";
}

<div id="list">
  <h1>@title</h1>

  @if (def.List?.Filters != null && def.List.Filters.Any())
  {
    <form hx-get="/ui/@modelName" hx-target="#list" hx-swap="innerHTML" hx-push-url="true">
      @foreach (var f in def.List.Filters)
      {
        var label = f.Value.Label;
        // Â∞ùËØïËé∑ÂèñÊú¨Âú∞ÂåñÊ†áÁ≠æ
        if(localizedLabels != null && localizedLabels.ContainsKey(f.Key))
        {
            label = localizedLabels[f.Key];
        }
        <label>@label
          @if (f.Value.Type == "select")
          {
            <select name="@f.Key">
              <option value="">--</option>
              @if (f.Value.Options != null)
              {
                @foreach (var o in f.Value.Options)
                {
                  <option value="@o.Key" 
                          selected="@(Context.Request.Query[f.Key].FirstOrDefault() == o.Key ? "selected" : null)">
                    @o.Value
                  </option>
                }
              }
            </select>
          }
          else
          {
            <input name="@f.Key" value="@(Context.Request.Query[f.Key].FirstOrDefault() ?? "")" placeholder="@searchPlaceholder" />
          }
        </label>
      }
      <!-- ÈöêËóèÂ≠óÊÆµ‰øùÁïôËØ≠Ë®ÄÂèÇÊï∞ -->
      <input type="hidden" name="lang" value="@currentLang" />
      <button type="submit" class="@buttonClass">@filterButtonLabel</button>
      <button type="submit" name="clear" value="true" class="@buttonClass"> @clearButtonLabel</button>
      
      <!-- ËØ≠Ë®ÄÂàáÊç¢ -->
      <select onchange="changeLanguage(this.value)" style="margin-left: 10px;">
        <option value="en" @(currentLang == "en" ? "selected" : "")>English</option>
        <option value="zh" @(currentLang == "zh" ? "selected" : "")>‰∏≠Êñá</option>
      </select>
    </form>
  }

  <button hx-get="/ui/@modelName/create?lang=@currentLang" hx-target="#modal" hx-swap="innerHTML">
    ‚ûï 
    @if (localizedLabels != null && localizedLabels.ContainsKey("new_button"))
    {
        @localizedLabels["new_button"]
    }
    else
    {
        @:New
    }
  </button>

  <div id="modal"></div>

  @if (def.List?.Columns != null && def.List.Columns.Any())
  {
    <table>
      <thead>
        <tr>
          @foreach (var col in def.List.Columns)
          {
            <!-- Â∞ùËØïËé∑ÂèñÊú¨Âú∞ÂåñÁöÑÂàóÊ†áÈ¢ò -->
            <th>
            @if (localizedLabels != null && localizedLabels.ContainsKey(col))
            {
                @localizedLabels[col]
            }
            else
            {
                @col
            }
            </th>
          }
          <th>
          @if (localizedLabels != null && localizedLabels.ContainsKey("Actions"))
          {
              @localizedLabels["Actions"]
          }
          else
          {
              @:Actions
          }
          </th>
        </tr>
      </thead>
      <tbody id="list-body">
        @foreach (var row in Model)
        {
          <tr data-id="@row[def.PrimaryKey]">
            @foreach (var col in def.List.Columns)
            {
              <td>@RenderValue(def, col, row[col])</td>
            }
            <td>
              <button class="secondary" hx-get="/ui/@modelName/edit/@row[def.PrimaryKey]?lang=@currentLang" hx-target="#modal" hx-swap="innerHTML">
              @if (localizedLabels != null && localizedLabels.ContainsKey("edit_button"))
              {
                  @localizedLabels["edit_button"]
              }
              else
              {
                  @:Edit
              }
              </button>
              <button class="danger" onclick="openDeleteDialog('@modelName', '@row[def.PrimaryKey]')">
              @if (localizedLabels != null && localizedLabels.ContainsKey("delete_button"))
              {
                  @localizedLabels["delete_button"]
              }
              else
              {
                  @:üóë
              }
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }

  <nav class="pagination">
    @if(pageNum > 1)
    {
      <a class="button" style="cursor:pointer;" hx-get="/ui/@modelName?page=@(pageNum-1)&size=@size&lang=@currentLang" hx-target="#list" hx-swap="innerHTML">‚Üê Prev</a>
    }

    @for (int i = 1; i <= totalPages; i++)
    {
      <a class="button" style="cursor:pointer; @(i == pageNum ? "opacity: 0.5;" : "")" hx-get="/ui/@modelName?page=@i&size=@size&lang=@currentLang" hx-target="#list" hx-swap="innerHTML">@i</a>
    }

    @if(pageNum < totalPages)
    {
      <a class="button" style="cursor:pointer;" hx-get="/ui/@modelName?page=@(pageNum+1)&size=@size&lang=@currentLang" hx-target="#list" hx-swap="innerHTML">Next ‚Üí</a>
    }

    <span>Page @pageNum of @totalPages (@total records)</span>
  </nav>
</div>
