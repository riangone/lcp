@using Platform.Infrastructure.Definitions
@model IEnumerable<Dictionary<string, object>>
@{
    var def = (ModelDefinition)ViewData["ModelDef"]!;
    var modelName = (string)ViewData["ModelName"]!;
    var pageNum = (int)ViewData["Page"]!;
    var size = (int)ViewData["Size"]!;
    var total = (int)ViewData["Total"]!;
    var totalPages = (int)Math.Ceiling((double)total / size);
    var currentLang = Context.Request.Query["lang"].FirstOrDefault() ?? ViewData["Lang"] as string ?? "en";
    var currentProject = Context.Request.Query["project"].FirstOrDefault() ?? "journal";
    var currentSortBy = (ViewData["SortBy"] as string) ?? def.PrimaryKey;
    var currentSortDir = string.Equals(ViewData["SortDir"] as string, "desc", StringComparison.OrdinalIgnoreCase) ? "desc" : "asc";
    var currentEditMode = string.Equals(ViewData["EditMode"] as string, "page", StringComparison.OrdinalIgnoreCase) ? "page" : "modal";

    // è·å–æœ¬åœ°åŒ–æ ‡ç­¾
    var localizedLabels = currentLang == "zh" ? def.Ui?.Labels?.Zh : def.Ui?.Labels?.En;
    var title = localizedLabels != null && localizedLabels.ContainsKey("title") ? localizedLabels["title"] : modelName;

    // å¿ƒæƒ…è¡¨æƒ…æ˜ å°„
    var moodEmojis = new Dictionary<string, string>
    {
        { "happy", "ğŸ˜Š" },
        { "good", "ğŸ™‚" },
        { "neutral", "ğŸ˜" },
        { "bad", "ğŸ˜”" },
        { "angry", "ğŸ˜ " }
    };

    var moodColors = new Dictionary<string, string>
    {
        { "happy", "#fef3c7" },
        { "good", "#d1fae5" },
        { "neutral", "#f3f4f6" },
        { "bad", "#fee2e2" },
        { "angry", "#7f1d1d" }
    };

    ViewData["Title"] = $"{title} - Low Code Platform";
}

<div class="journal-container">
    <!-- å¤´éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="journal-header">
        <div class="journal-stats">
            <div class="stat-item">
                <span class="stat-value">@total</span>
                <span class="stat-label">@(currentLang == "zh" ? "ç¯‡æ—¥è®°" : "Entries")</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">@Model.Count()</span>
                <span class="stat-label">@(currentLang == "zh" ? "å½“å‰æ˜¾ç¤º" : "Showing")</span>
            </div>
        </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="journal-toolbar">
        <div class="toolbar-left">
            <a href="/Entry/create?project=@currentProject&lang=@currentLang&editMode=@currentEditMode"
               class="btn btn-primary btn-write">
                <i class="fas fa-pen-fancy"></i>
                @(currentLang == "zh" ? "å†™æ—¥è®°" : "Write")
            </a>
        </div>
        <div class="toolbar-right">
            <!-- UI åˆ‡æ¢æŒ‰é’® -->
            <a href="/Entry?project=@currentProject&lang=@currentLang&ui=generic"
               class="btn btn-outline btn-sm"
               title="@(currentLang == "zh" ? "åˆ‡æ¢åˆ°é€šç”¨ UI" : "Switch to Generic UI")">
                <i class="fas fa-th-large"></i>
                @(currentLang == "zh" ? "é€šç”¨è§†å›¾" : "Generic View")
            </a>
            <a href="/Entry?project=@currentProject&lang=@currentLang&ui=custom"
               class="btn btn-outline btn-sm"
               title="@(currentLang == "zh" ? "åˆ‡æ¢åˆ°ä¸“ç”¨ UI" : "Switch to Custom UI")"
               style="display: none;" id="show-custom-ui-btn">
                <i class="fas fa-stream"></i>
                @(currentLang == "zh" ? "ä¸“ç”¨è§†å›¾" : "Custom View")
            </a>

            <form class="search-form" hx-get="/Entry?project=@currentProject" hx-target="#journal-list" hx-swap="innerHTML" hx-push-url="true">
                <input type="text" name="Title" placeholder="@(currentLang == "zh" ? "æœç´¢æ—¥è®°..." : "Search entries...")" 
                       value="@(Context.Request.Query["Title"].FirstOrDefault() ?? "")"
                       class="search-input" />
                <button type="submit" class="btn-search">
                    <i class="fas fa-search"></i>
                </button>
            </form>
            
            <!-- å¿ƒæƒ…è¿‡æ»¤å™¨ -->
            <select name="Mood" class="mood-filter" onchange="filterByMood(this.value)">
                <option value="">@(currentLang == "zh" ? "æ‰€æœ‰å¿ƒæƒ…" : "All Moods")</option>
                @foreach (var mood in moodEmojis)
                {
                    <option value="@mood.Key" selected="@(Context.Request.Query["Mood"].FirstOrDefault() == mood.Key ? "selected" : null)">
                        @mood.Value @mood.Key
                    </option>
                }
            </select>
        </div>
    </div>

    <!-- æ—¥è®°åˆ—è¡¨ï¼ˆæ—¶é—´çº¿é£æ ¼ï¼‰ -->
    <div id="journal-list" class="journal-timeline">
        @foreach (var entry in Model)
        {
            var mood = entry.ContainsKey("Mood") ? entry["Mood"]?.ToString() ?? "neutral" : "neutral";
            var moodEmoji = moodEmojis.ContainsKey(mood) ? moodEmojis[mood] : "ğŸ˜";
            var moodBgColor = moodColors.ContainsKey(mood) ? moodColors[mood] : "#f3f4f6";
            var titleText = entry.ContainsKey("Title") ? entry["Title"]?.ToString() ?? "" : "";
            var dateStr = entry.ContainsKey("Date") ? entry["Date"]?.ToString() ?? "" : "";
            var content = entry.ContainsKey("Content") ? entry["Content"]?.ToString() ?? "" : "";
            var id = entry[def.PrimaryKey]?.ToString() ?? "";

            // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
            var displayDate = dateStr;
            if (DateTime.TryParse(dateStr, out var parsedDate))
            {
                displayDate = currentLang == "zh" 
                    ? parsedDate.ToString("yyyy å¹´ MM æœˆ dd æ—¥ dddd") 
                    : parsedDate.ToString("MMMM dd, yyyy dddd");
            }

            <article class="timeline-entry" data-mood="@mood" data-id="@id">
                <div class="entry-marker" style="background-color: @moodBgColor">
                    <span class="mood-emoji">@moodEmoji</span>
                </div>
                <div class="entry-content-wrapper">
                    <header class="entry-header">
                        <div class="entry-meta">
                            <time class="entry-date" datetime="@dateStr">
                                <i class="far fa-calendar-alt"></i> @displayDate
                            </time>
                            <span class="entry-mood" style="background-color: @moodBgColor">
                                @moodEmoji @mood
                            </span>
                        </div>
                        <div class="entry-actions">
                            <a href="/Entry/edit/@id?project=@currentProject&lang=@currentLang&editMode=@currentEditMode"
                               class="btn-icon btn-edit"
                               hx-get="/Entry/edit/@id?project=@currentProject&lang=@currentLang&editMode=@currentEditMode"
                               hx-target="#modal"
                               hx-swap="innerHTML">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn-icon btn-delete" onclick="openDeleteDialog('@modelName', '@id')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </header>
                    <h3 class="entry-title">@titleText</h3>
                    <div class="entry-excerpt">
                        @(content.Length > 200 ? content.Substring(0, 200) + "..." : content)
                    </div>
                    <footer class="entry-footer">
                        <a href="/Entry/details/@id?project=@currentProject&lang=@currentLang" class="read-more">
                            @(currentLang == "zh" ? "é˜…è¯»å…¨æ–‡" : "Read more") <i class="fas fa-arrow-right"></i>
                        </a>
                    </footer>
                </div>
            </article>
        }

        @if (!Model.Any())
        {
            <div class="empty-state">
                <i class="fas fa-book-open empty-icon"></i>
                <h3>@(currentLang == "zh" ? "è¿˜æ²¡æœ‰æ—¥è®°" : "No entries yet")</h3>
                <p>@(currentLang == "zh" ? "å¼€å§‹å†™ä¸‹ä½ çš„ç¬¬ä¸€ç¯‡æ—¥è®°å§ï¼" : "Start writing your first entry!")</p>
                <a href="/Entry/create?project=@currentProject&lang=@currentLang" class="btn btn-primary">
                    <i class="fas fa-pen-fancy"></i> @(currentLang == "zh" ? "å†™æ—¥è®°" : "Write now")
                </a>
            </div>
        }
    </div>

    <!-- åˆ†é¡µ -->
    @if (totalPages > 1)
    {
        <nav class="journal-pagination">
            @if (pageNum > 1)
            {
                <a href="/Entry?project=@currentProject&page=1&lang=@currentLang" class="pagination-btn">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="/Entry?project=@currentProject&page=@(pageNum-1)&lang=@currentLang" class="pagination-btn">
                    <i class="fas fa-angle-left"></i>
                </a>
            }

            <span class="pagination-info">
                @(currentLang == "zh" ? "ç¬¬" : "Page") @pageNum @(currentLang == "zh" ? "é¡µï¼Œå…±" : "of") @totalPages @(currentLang == "zh" ? "é¡µ" : "pages")
            </span>

            @if (pageNum < totalPages)
            {
                <a href="/Entry?project=@currentProject&page=@(pageNum+1)&lang=@currentLang" class="pagination-btn">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="/Entry?project=@currentProject&page=@totalPages&lang=@currentLang" class="pagination-btn">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            }
        </nav>
    }
</div>

<!-- æ¨¡æ€æ¡†å®¹å™¨ -->
<div id="modal"></div>

<style>
    /* æ—¥è®°ä¸“ç”¨æ ·å¼ */
    .journal-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
    }

    .journal-header {
        margin-bottom: 2rem;
    }

    .journal-stats {
        display: flex;
        gap: 2rem;
        justify-content: center;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        display: block;
        font-size: 2.5rem;
        font-weight: bold;
        color: #3b82f6;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .journal-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .toolbar-right {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .btn-write {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: transform 0.2s;
    }

    .btn-write:hover {
        transform: translateY(-2px);
    }

    .search-form {
        display: flex;
        gap: 0.5rem;
    }

    .search-input {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        width: 250px;
    }

    .btn-search {
        padding: 0.5rem 1rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .mood-filter {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        cursor: pointer;
    }

    /* æ—¶é—´çº¿æ ·å¼ */
    .journal-timeline {
        position: relative;
        padding-left: 3rem;
    }

    .journal-timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #3b82f6, #8b5cf6, #ec4899);
    }

    .timeline-entry {
        position: relative;
        margin-bottom: 2rem;
        animation: slideIn 0.5s ease;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .entry-marker {
        position: absolute;
        left: -3rem;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .mood-emoji {
        font-size: 1.25rem;
    }

    .entry-content-wrapper {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .entry-content-wrapper:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .entry-meta {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .entry-date {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .entry-mood {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .entry-actions {
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .entry-content-wrapper:hover .entry-actions {
        opacity: 1;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: #f3f4f6;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: #3b82f6;
        color: white;
    }

    .btn-delete:hover {
        background: #ef4444;
    }

    .entry-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.75rem;
    }

    .entry-excerpt {
        color: #4b5563;
        line-height: 1.7;
        margin-bottom: 1rem;
    }

    .entry-footer {
        border-top: 1px solid #e5e7eb;
        padding-top: 0.75rem;
    }

    .read-more {
        color: #3b82f6;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
    }

    .read-more:hover {
        color: #8b5cf6;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #9ca3af;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .pagination-btn {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        color: #3b82f6;
        text-decoration: none;
        transition: all 0.2s;
    }

    .pagination-btn:hover {
        background: #3b82f6;
        color: white;
    }

    .pagination-info {
        padding: 0.5rem 1rem;
        color: #6b7280;
    }

    @@media (max-width: 768px) {
        .journal-toolbar {
            flex-direction: column;
            gap: 1rem;
        }

        .toolbar-right {
            flex-wrap: wrap;
            justify-content: center;
        }

        .search-input {
            width: 100%;
        }

        .journal-timeline {
            padding-left: 2rem;
        }

        .entry-marker {
            left: -2rem;
            width: 2rem;
            height: 2rem;
        }
    }
</style>

<script>
    function filterByMood(mood) {
        const entries = document.querySelectorAll('.timeline-entry');
        entries.forEach(entry => {
            if (mood === '' || entry.dataset.mood === mood) {
                entry.style.display = '';
            } else {
                entry.style.display = 'none';
            }
        });
    }
</script>
