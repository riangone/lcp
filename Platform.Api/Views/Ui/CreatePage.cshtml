@using Platform.Infrastructure.Definitions
@{
    var def = (ModelDefinition)ViewData["ModelDef"]!;
    var modelName = (string)ViewData["ModelName"]!;
    var returnUrl = ViewData["ReturnUrl"] as string;
    var createError = ViewData["CreateError"] as string;
    var project = Context.Request.Query["project"].FirstOrDefault() ?? "app";
    var backUrl = !string.IsNullOrWhiteSpace(returnUrl) ? returnUrl! : $"/ui/{modelName}?project={project}";

    var currentLang = Context.Request.Query["lang"].FirstOrDefault() ?? ViewData["Lang"] as string ?? "en";
    var uiLabels = def.Ui?.Labels;
    Dictionary<string, string>? localizedLabels = null;

    if (uiLabels != null)
    {
        if (currentLang == "zh" && uiLabels.Zh != null)
        {
            localizedLabels = uiLabels.Zh;
        }
        else if (currentLang == "en" && uiLabels.En != null)
        {
            localizedLabels = uiLabels.En;
        }
    }

    localizedLabels ??= new Dictionary<string, string>();
    var createLabel = localizedLabels.ContainsKey("create_form_title") ? localizedLabels["create_form_title"] : "Create";
    var saveLabel = localizedLabels.ContainsKey("save_button") ? localizedLabels["save_button"] : "Save";
    var cancelLabel = localizedLabels.ContainsKey("cancel_button") ? localizedLabels["cancel_button"] : "Cancel";
    ViewData["Title"] = $"{createLabel} {modelName}";
}

<div class="form-page-container">
  <div class="@def.Ui?.Styles?.CardClass">
    <div class="form-header">
      <h1 class="form-title">@createLabel @modelName</h1>
      <a href="@backUrl" class="btn btn-outline">@cancelLabel</a>
    </div>

    @if (!string.IsNullOrWhiteSpace(createError))
    {
      <div class="error-message">
        @createError
      </div>
    }

    <form method="post" action="/ui/@modelName/create-page" class="form-content">
      @Html.AntiForgeryToken()
      <input type="hidden" name="returnUrl" value="@backUrl" />

      @foreach (var f in def.Form!.Fields)
      {
          var fieldLabel = localizedLabels.ContainsKey(f.Key) ? localizedLabels[f.Key] : f.Value.Label;

          <div class="form-group">
            <label class="form-label">
              @fieldLabel @(f.Value.Required ? "*" : "")
            </label>

            @if (f.Value.Type == "select")
            {
                <select name="@f.Key"
                        class="form-control"
                        @(f.Value.Required ? "required" : "")>
                  <option value="">Select...</option>
                  @if (f.Value.Options != null)
                  {
                      @foreach (var opt in f.Value.Options)
                      {
                          <option value="@opt.Key">@opt.Value</option>
                      }
                  }
                </select>
            }
            else
            {
                var inputType = f.Value.Type == "decimal" ? "number" : f.Value.Type;
                var step = f.Value.Type == "decimal" ? "step=\"0.01\"" : "";
                <input
                  name="@f.Key"
                  type="@inputType"
                  @Html.Raw(step)
                  class="form-control"
                  @(f.Value.Required ? "required" : "")
                  @(f.Value.MinLength.HasValue ? $"minlength=\"{f.Value.MinLength}\"" : "")
                  @(f.Value.MaxLength.HasValue ? $"maxlength=\"{f.Value.MaxLength}\"" : "")
                  @(f.Value.Min.HasValue ? $"min=\"{f.Value.Min}\"" : "")
                  @(f.Value.Max.HasValue ? $"max=\"{f.Value.Max}\"" : "") />
            }
          </div>
      }

      <div class="form-actions">
        <a href="@backUrl" class="btn btn-outline">@cancelLabel</a>
        <button type="submit" class="btn btn-primary">@saveLabel</button>
      </div>
    </form>
  </div>
</div>

<style>
  .form-page-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }
  
  .form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-light);
  }
  
  .form-title {
    margin: 0;
    font-size: var(--text-2xl);
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .error-message {
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    font-size: var(--text-sm);
  }
  
  .form-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .form-label {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--text-primary);
  }
  
  .form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-medium);
    border-radius: var(--radius);
    font-size: var(--text-base);
    transition: all 0.2s ease;
  }
  
  .form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  select.form-control {
    background-color: white;
    cursor: pointer;
  }
  
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding-top: 1rem;
    margin-top: 0.5rem;
  }
</style>
