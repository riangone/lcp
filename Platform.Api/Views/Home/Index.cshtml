@model Platform.Infrastructure.Definitions.HomeDefinition
@using YamlDotNet.Serialization
@{
    ViewData["Title"] = Model?.Title ?? "LowCode Platform";
    ViewData["ActivePage"] = "Home";
}
<div class="min-h-screen">
@if (Model?.Layout != null)
{
    foreach (var component in Model.Layout)
    {
        var viewName = GetComponentViewName(component.Type);
        try
        {
            // 使用 YamlDotNet 将 Dictionary 转换为强类型对象
            var typedData = ConvertToTypedData(component.Data, component.Type);
            await Html.RenderPartialAsync(viewName, typedData);
        }
        catch (Exception ex)
        {
            <div class="text-red-500 p-4 bg-red-50 rounded-lg mb-4">
                <div class="font-bold">Component '@component.Type' not found or failed</div>
                <div class="text-sm mt-2 font-mono">@ex.Message</div>
            </div>
        }
    }
}
else
{
    await Html.RenderPartialAsync("_DefaultHome");
}
</div>

@functions {
    string GetComponentViewName(string type)
    {
        return type switch
        {
            "hero" => "~/Views/Home/Components/_Hero.cshtml",
            "quick_actions" => "~/Views/Home/Components/_QuickActions.cshtml",
            "section_title" => "~/Views/Home/Components/_SectionTitle.cshtml",
            "card_grid" => "~/Views/Home/Components/_CardGrid.cshtml",
            "stats_modern" => "~/Views/Home/Components/_StatsModern.cshtml",
            "footer" => "~/Views/Home/Components/_Footer.cshtml",
            "alert" => "~/Views/Home/Components/_Alert.cshtml",
            "stats" => "~/Views/Home/Components/_Stats.cshtml",
            _ => $"~/Views/Home/Components/_{type}.cshtml"
        };
    }

    object? ConvertToTypedData(Dictionary<string, object> data, string type)
    {
        try
        {
            // 使用 YamlDotNet 序列化/反序列化，保持类型一致性
            var serializer = new SerializerBuilder().Build();
            var yaml = serializer.Serialize(data);
            
            var deserializer = new DeserializerBuilder()
                .WithNamingConvention(YamlDotNet.Serialization.NamingConventions.UnderscoredNamingConvention.Instance)
                .IgnoreUnmatchedProperties()
                .Build();
            
            return type switch
            {
                "hero" => deserializer.Deserialize<Platform.Infrastructure.Definitions.HeroConfig>(yaml),
                "quick_actions" => deserializer.Deserialize<Platform.Infrastructure.Definitions.QuickActionsConfig>(yaml),
                "section_title" => deserializer.Deserialize<Platform.Infrastructure.Definitions.SectionTitleConfig>(yaml),
                "card_grid" => deserializer.Deserialize<Platform.Infrastructure.Definitions.CardGridConfig>(yaml),
                "stats_modern" => deserializer.Deserialize<Platform.Infrastructure.Definitions.StatsModernConfig>(yaml),
                "footer" => deserializer.Deserialize<Platform.Infrastructure.Definitions.FooterConfig>(yaml),
                "alert" => deserializer.Deserialize<Platform.Infrastructure.Definitions.AlertConfig>(yaml),
                "stats" => deserializer.Deserialize<Platform.Infrastructure.Definitions.StatsConfig>(yaml),
                _ => data
            };
        }
        catch (Exception ex)
        {
            using (var writer = File.AppendText("/tmp/home_debug.log"))
            {
                writer.WriteLine($"[{DateTime.Now:yyyy-MM-dd HH:mm:ss.fff}] ConvertToTypedData error for {type}: {ex.Message}");
            }
            return data;
        }
    }
}
