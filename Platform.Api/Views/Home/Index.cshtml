@model Platform.Infrastructure.Definitions.HomeDefinition
@using YamlDotNet.Serialization
@{
    ViewData["Title"] = Model?.Title ?? "LowCode Platform";
    ViewData["ActivePage"] = "Home";
}
<div class="min-h-screen">
@if (Model?.Layout != null)
{
    foreach (var component in Model.Layout)
    {
        var viewName = GetComponentViewName(component.Type);
        try
        {
            // 使用 YamlDotNet 将 Dictionary 转换为强类型对象
            var typedData = ConvertToTypedData(component.Data, component.Type);
            await Html.RenderPartialAsync(viewName, typedData);
        }
        catch (Exception ex)
        {
            <div class="text-red-500 p-4 bg-red-50 rounded-lg mb-4">
                <div class="font-bold">Component '@component.Type' not found or failed</div>
                <div class="text-sm mt-2 font-mono">@ex.Message</div>
            </div>
        }
    }
}
else
{
    await Html.RenderPartialAsync("_DefaultHome");
}
</div>

@functions {
    string GetComponentViewName(string type)
    {
        return type switch
        {
            "hero" => "~/Views/Home/Components/_Hero.cshtml",
            "quick_actions" => "~/Views/Home/Components/_QuickActions.cshtml",
            "section_title" => "~/Views/Home/Components/_SectionTitle.cshtml",
            "card_grid" => "~/Views/Home/Components/_CardGrid.cshtml",
            "stats_modern" => "~/Views/Home/Components/_StatsModern.cshtml",
            "footer" => "~/Views/Home/Components/_Footer.cshtml",
            "alert" => "~/Views/Home/Components/_Alert.cshtml",
            "stats" => "~/Views/Home/Components/_Stats.cshtml",
            // CRM 新增组件
            "nav_pipeline" => "~/Views/Home/Components/_NavPipeline.cshtml",
            "stats_row" => "~/Views/Home/Components/_StatsRow.cshtml",
            "role_based_actions" => "~/Views/Home/Components/_RoleBasedActions.cshtml",
            "card_grid_modern" => "~/Views/Home/Components/_CardGridModern.cshtml",
            "funnel_chart" => "~/Views/Home/Components/_FunnelChart.cshtml",
            "activity_timeline" => "~/Views/Home/Components/_ActivityTimeline.cshtml",
            "reminders" => "~/Views/Home/Components/_Reminders.cshtml",
            _ => $"~/Views/Home/Components/_{type}.cshtml"
        };
    }

    object? ConvertToTypedData(Dictionary<string, object> data, string type)
    {
        try
        {
            // CRM 新增组件 - 直接传递 Dictionary，组件内部使用 dynamic 访问
            // 原有组件使用强类型转换
            return type switch
            {
                "nav_pipeline" => data,
                "stats_row" => data,
                "role_based_actions" => data,
                "card_grid_modern" => data,
                "funnel_chart" => data,
                "activity_timeline" => data,
                "reminders" => data,
                // 原有组件使用强类型转换
                "hero" => ConvertToStrongType<Platform.Infrastructure.Definitions.HeroConfig>(data),
                "quick_actions" => ConvertToStrongType<Platform.Infrastructure.Definitions.QuickActionsConfig>(data),
                "section_title" => ConvertToStrongType<Platform.Infrastructure.Definitions.SectionTitleConfig>(data),
                "card_grid" => ConvertToStrongType<Platform.Infrastructure.Definitions.CardGridConfig>(data),
                "stats_modern" => ConvertToStrongType<Platform.Infrastructure.Definitions.StatsModernConfig>(data),
                "footer" => ConvertToStrongType<Platform.Infrastructure.Definitions.FooterConfig>(data),
                "alert" => ConvertToStrongType<Platform.Infrastructure.Definitions.AlertConfig>(data),
                "stats" => ConvertToStrongType<Platform.Infrastructure.Definitions.StatsConfig>(data),
                _ => data
            };
        }
        catch (Exception ex)
        {
            using (var writer = File.AppendText("/tmp/home_debug.log"))
            {
                writer.WriteLine($"[{DateTime.Now:yyyy-MM-dd HH:mm:ss.fff}] ConvertToTypedData error for {type}: {ex.Message}");
            }
            return data;
        }
    }
    
    T? ConvertToStrongType<T>(Dictionary<string, object> data) where T : class
    {
        try
        {
            var serializer = new SerializerBuilder().Build();
            var yaml = serializer.Serialize(data);

            var deserializer = new DeserializerBuilder()
                .WithNamingConvention(YamlDotNet.Serialization.NamingConventions.UnderscoredNamingConvention.Instance)
                .IgnoreUnmatchedProperties()
                .Build();

            return deserializer.Deserialize<T>(yaml);
        }
        catch
        {
            return null;
        }
    }
}
