@{
    var projectName = Context.Request.Query["project"].FirstOrDefault() ?? "app";
}

<script>
    // é¡¹ç›®å˜é‡ï¼ˆä» Razor ä¼ é€’ï¼‰
    const currentProjectName = "@projectName";
    
    // ç”¨æˆ·çŠ¶æ€ç®¡ç†
    window.auth = {
        getToken: function() {
            return localStorage.getItem('authToken');
        },
        
        getUser: function() {
            const userStr = localStorage.getItem('authUser');
            return userStr ? JSON.parse(userStr) : null;
        },
        
        isLoggedIn: function() {
            return !!this.getToken();
        },
        
        login: function(token, user) {
            localStorage.setItem('authToken', token);
            localStorage.setItem('authUser', JSON.stringify(user));
            this.updateUI();
        },
        
        logout: async function() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + this.getToken()
                    }
                });
            } catch (e) {
                console.error('Logout error:', e);
            }
            localStorage.removeItem('authToken');
            localStorage.removeItem('authUser');
            this.updateUI();
        },
        
        updateUI: function() {
            const user = this.getUser();
            const isLoggedIn = this.isLoggedIn();
            const currentLang = new URLSearchParams(window.location.search).get('lang') || 'en';
            const isZh = currentLang === 'zh';
            const projName = currentProjectName || new URLSearchParams(window.location.search).get('project') || 'app';
            
            // æ›´æ–°æ¡Œé¢ç‰ˆå¯¼èˆªæ ç”¨æˆ·çŠ¶æ€
            const userStatusEl = document.querySelector('.user-status-display');
            if (userStatusEl) {
                if (isLoggedIn && user) {
                    userStatusEl.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="user-details">
                                <div class="user-name">${user.displayName || user.username}</div>
                                <div class="user-role">${user.role === 'Admin' ? (isZh ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘‘ Admin') : (isZh ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ‘¤ User')}</div>
                            </div>
                        </div>
                        <div class="user-actions">
                            <a href="/?project=${projName}" class="user-action-btn">
                                <i class="fas fa-home"></i> ${isZh ? 'é¦–é¡µ' : 'Home'}
                            </a>
                            <button type="button" class="user-action-btn" onclick="auth.logout()">
                                <i class="fas fa-sign-out-alt"></i> ${isZh ? 'ç™»å‡º' : 'Logout'}
                            </button>
                        </div>
                    `;
                } else {
                    userStatusEl.innerHTML = `
                        <div class="guest-user">
                            <p>${isZh ? 'è®¿å®¢æ¨¡å¼ï¼ˆGuestï¼‰' : 'Guest Mode'}</p>
                            <p class="guest-hint">${isZh ? 'ç™»å½•ä»¥è®¿é—®æ›´å¤šåŠŸèƒ½' : 'Login for more features'}</p>
                            <div class="guest-actions">
                                <a href="/auth/login?project=${projName}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-sign-in-alt"></i> ${isZh ? 'ç™»å½•' : 'Login'}
                                </a>
                                <a href="/auth/register?project=${projName}" class="btn btn-outline btn-sm">
                                    <i class="fas fa-user-plus"></i> ${isZh ? 'æ³¨å†Œ' : 'Register'}
                                </a>
                            </div>
                        </div>
                    `;
                }
            }
            
            // æ›´æ–°ç§»åŠ¨ç‰ˆå¯¼èˆªæ ç”¨æˆ·èœå•
            const mobileAuthEl = document.getElementById('mobile-auth-menu');
            if (mobileAuthEl) {
                if (isLoggedIn && user) {
                    mobileAuthEl.innerHTML = `
                        <div class="mobile-user-logged-in">
                            <div class="mobile-user-info">
                                <i class="fas fa-user-circle fa-2x" style="color: #667eea; margin-right: 12px;"></i>
                                <div>
                                    <div style="font-weight: 600; color: #333;">${user.displayName || user.username}</div>
                                    <div style="font-size: 12px; color: #666;">${user.role === 'Admin' ? (isZh ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘‘ Admin') : (isZh ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ‘¤ User')}</div>
                                </div>
                            </div>
                            <div class="mobile-user-actions" style="margin-top: 12px; display: flex; gap: 8px;">
                                <a href="/?project=${projName}" class="btn btn-sm btn-primary" style="flex: 1;">
                                    <i class="fas fa-home"></i> ${isZh ? 'é¦–é¡µ' : 'Home'}
                                </a>
                                <button type="button" class="btn btn-sm btn-outline" onclick="auth.logout()" style="flex: 1;">
                                    <i class="fas fa-sign-out-alt"></i> ${isZh ? 'ç™»å‡º' : 'Logout'}
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    mobileAuthEl.innerHTML = `
                        <a href="/auth/login?project=${projName}" class="nav-link mobile-close-on-click">
                            <i class="fas fa-sign-in-alt"></i>
                            ${isZh ? 'ç”¨æˆ·ç™»å½•' : 'Login'}
                        </a>
                    `;
                }
            }
        }
    };
    
    // é¡µé¢åŠ è½½æ—¶æ›´æ–°ç”¨æˆ·çŠ¶æ€
    document.addEventListener('DOMContentLoaded', function() {
        window.auth.updateUI();
    });
</script>

<style>
    .user-status-display {
        font-size: 14px;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        margin-bottom: 8px;
    }
    
    .user-avatar {
        font-size: 32px;
        color: #667eea;
        margin-right: 12px;
    }
    
    .user-details {
        flex: 1;
    }
    
    .user-name {
        font-weight: 600;
        color: #333;
        font-size: 15px;
    }
    
    .user-role {
        color: #666;
        font-size: 12px;
        margin-top: 2px;
    }
    
    .user-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px;
    }
    
    .user-action-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: none;
        background: #f8f9fa;
        border-radius: 6px;
        color: #555;
        text-decoration: none;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .user-action-btn:hover {
        background: #e9ecef;
    }
    
    .guest-user {
        padding: 12px;
    }
    
    .guest-user p {
        margin: 4px 0;
        color: #666;
    }
    
    .guest-hint {
        font-size: 12px;
        color: #999;
    }
    
    .guest-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        flex: 1;
        text-align: center;
    }
    
    /* ç§»åŠ¨ç«¯ç”¨æˆ·ç™»å½•æ ·å¼ */
    .mobile-user-logged-in {
        padding: 16px;
        border-top: 1px solid #eee;
        background: #f8f9ff;
    }
    
    .mobile-user-info {
        display: flex;
        align-items: center;
        padding-bottom: 12px;
        border-bottom: 1px solid #e0e4ff;
    }
    
    .mobile-user-actions .btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
</style>
