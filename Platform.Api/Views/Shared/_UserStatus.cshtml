@{
    var projectName = Context.Request.Query["project"].FirstOrDefault() ?? "app";
}

<script>
    // ç”¨æˆ·çŠ¶æ€ç®¡ç†
    window.auth = {
        getToken: function() {
            return localStorage.getItem('authToken');
        },
        
        getUser: function() {
            const userStr = localStorage.getItem('authUser');
            return userStr ? JSON.parse(userStr) : null;
        },
        
        isLoggedIn: function() {
            return !!this.getToken();
        },
        
        login: function(token, user) {
            localStorage.setItem('authToken', token);
            localStorage.setItem('authUser', JSON.stringify(user));
            this.updateUI();
        },
        
        logout: async function() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + this.getToken()
                    }
                });
            } catch (e) {
                console.error('Logout error:', e);
            }
            localStorage.removeItem('authToken');
            localStorage.removeItem('authUser');
            this.updateUI();
        },
        
        updateUI: function() {
            const user = this.getUser();
            const isLoggedIn = this.isLoggedIn();
            
            // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·çŠ¶æ€
            const userStatusEl = document.querySelector('.user-status-display');
            if (userStatusEl) {
                if (isLoggedIn && user) {
                    userStatusEl.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="user-details">
                                <div class="user-name">${user.displayName || user.username}</div>
                                <div class="user-role">${user.role === 'Admin' ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘¤ ç”¨æˆ·'}</div>
                            </div>
                        </div>
                        <div class="user-actions">
                            <a href="/?project=${projectName}" class="user-action-btn">
                                <i class="fas fa-home"></i> é¦–é¡µ
                            </a>
                            <button type="button" class="user-action-btn" onclick="auth.logout()">
                                <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                            </button>
                        </div>
                    `;
                } else {
                    userStatusEl.innerHTML = `
                        <div class="guest-user">
                            <p>è®¿å®¢æ¨¡å¼ï¼ˆGuestï¼‰</p>
                            <p class="guest-hint">ç™»å½•ä»¥è®¿é—®æ›´å¤šåŠŸèƒ½</p>
                            <div class="guest-actions">
                                <a href="/auth/login?project=${projectName}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-sign-in-alt"></i> ç™»å½•
                                </a>
                                <a href="/auth/register?project=${projectName}" class="btn btn-outline btn-sm">
                                    <i class="fas fa-user-plus"></i> æ³¨å†Œ
                                </a>
                            </div>
                        </div>
                    `;
                }
            }
        }
    };
    
    // é¡µé¢åŠ è½½æ—¶æ›´æ–°ç”¨æˆ·çŠ¶æ€
    document.addEventListener('DOMContentLoaded', function() {
        window.auth.updateUI();
    });
</script>

<style>
    .user-status-display {
        font-size: 14px;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        margin-bottom: 8px;
    }
    
    .user-avatar {
        font-size: 32px;
        color: #667eea;
        margin-right: 12px;
    }
    
    .user-details {
        flex: 1;
    }
    
    .user-name {
        font-weight: 600;
        color: #333;
        font-size: 15px;
    }
    
    .user-role {
        color: #666;
        font-size: 12px;
        margin-top: 2px;
    }
    
    .user-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px;
    }
    
    .user-action-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: none;
        background: #f8f9fa;
        border-radius: 6px;
        color: #555;
        text-decoration: none;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .user-action-btn:hover {
        background: #e9ecef;
    }
    
    .guest-user {
        padding: 12px;
    }
    
    .guest-user p {
        margin: 4px 0;
        color: #666;
    }
    
    .guest-hint {
        font-size: 12px;
        color: #999;
    }
    
    .guest-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        flex: 1;
        text-align: center;
    }
</style>
