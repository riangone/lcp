# 订单管理页面 - 单个表单对应多个表（订单 + 订单明细）
title: 订单管理
description: 管理订单及其明细数据

# 多表 CRUD 配置
multi_table_crud:
  # 主表配置
  main_table:
    table: Invoice
    primary_key: InvoiceId
    
  # 关联表配置
  related_tables:
    - table: InvoiceLine
      foreign_key: InvoiceId
      type: many  # many=一对多，one=一对一
      
  # 事务配置
  transaction:
    enabled: true
    isolation_level: ReadCommitted  # ReadUncommitted, ReadCommitted, RepeatableRead, Serializable
    timeout_seconds: 30
    
  # 级联操作配置
  cascade:
    on_delete: true   # 删除主表记录时级联删除关联表
    on_update: false  # 更新主表主键时级联更新（通常不需要）
    
  # 处理步骤配置
  steps:
    # 保存前验证步骤
    - id: validate_total
      name: 验证订单总额
      trigger: before_save
      type: script
      stop_on_error: true
      script:
        language: csharp
        content: |
          // 验证订单总额是否为正数
          if (data.Total <= 0) {
            throw new Exception("订单总额必须大于 0");
          }
          return true;

    # 保存后发送通知
    - id: send_notification
      name: 发送订单通知
      trigger: after_save
      type: notification
      stop_on_error: false
      notification:
        type: email
        recipients:
          - admin@example.com
          - sales@example.com
        subject: "新订单通知 - {{InvoiceId}}"
        message_template: |
          新订单已创建：
          订单 ID: {{InvoiceId}}
          客户 ID: {{CustomerId}}
          订单日期：{{InvoiceDate}}
          订单总额：{{Total}}

    # 保存后调用外部 API
    - id: sync_erp
      name: 同步到 ERP 系统
      trigger: after_save
      type: api
      stop_on_error: false
      api:
        url: "https://erp.example.com/api/orders"
        method: POST
        headers:
          Content-Type: application/json
          Authorization: "Bearer {{API_TOKEN}}"
        body_template: |
          {
            "orderId": "{{InvoiceId}}",
            "customerId": {{CustomerId}},
            "orderDate": "{{InvoiceDate}}",
            "total": {{Total}},
            "items": {{InvoiceLine}}
          }
    
  # 表单字段映射到多个表
  form_mapping:
    # 映射到主表的字段
    Invoice:
      - field: CustomerId
        label: 客户 ID
        type: number
        required: true
      - field: InvoiceDate
        label: 发票日期
        type: date
        required: true
      - field: BillingAddress
        label: 账单地址
        type: text
        max_length: 70
      - field: BillingCity
        label: 账单城市
        type: text
        max_length: 40
      - field: BillingCountry
        label: 账单国家
        type: text
        max_length: 40
      - field: Total
        label: 总计
        type: decimal
        required: true
        
    # 映射到关联表的字段（一对多）
    InvoiceLine:
      - field: TrackId
        label: 音轨 ID
        type: number
        required: true
      - field: AlbumId
        label: 专辑 ID
        type: number
      - field: Quantity
        label: 数量
        type: number
        required: true
        default: 1
      - field: UnitPrice
        label: 单价
        type: decimal
        required: true

# 列表显示配置
list:
  columns:
    - InvoiceId
    - CustomerId
    - InvoiceDate
    - Total
  filters:
    CustomerId:
      label: 客户 ID
      type: like
    BillingCity:
      label: 城市
      type: like

# UI 配置
ui:
  theme: default
  # 表单布局
  form_layout:
    - section: 订单信息
      fields:
        - CustomerId
        - InvoiceDate
        - BillingAddress
        - BillingCity
        - BillingCountry
        - Total
    - section: 订单明细
      type: grid  # 网格布局，支持多行
      fields:
        - TrackId
        - AlbumId
        - Quantity
        - UnitPrice
      allow_multiple: true  # 允许添加多行
